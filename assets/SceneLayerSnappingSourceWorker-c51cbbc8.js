import{e as w,n as v}from"./cast-a534ae90.js";import{t as _,i as L}from"./typedArrayUtil-d9bc5fbd.js";import{f as V}from"./promiseUtils-32d9c228.js";import"./Error-57322e92.js";import"./ensureType-25b8cc06.js";import"./string-480f3e3f.js";import{q as l,x as u,u as h}from"./vec3-1863987c.js";import{n as d,t as c}from"./vec3f64-6cd30318.js";import{v as j,b as $,j as P}from"./lineSegment-c6f0b9d1.js";import{R as S,k as f,N as b}from"./sphere-622880b9.js";import{q as C}from"./QueryEngineResult-92e13fe4.js";import{G as E}from"./Octree-8ed6dc77.js";import{m as I}from"./edgeProcessing-5c860c29.js";import"./nextTick-3ee5a785.js";import"./common-c186b691.js";import"./mathUtils-57aba1ea.js";import"./vec4-46a9b36d.js";import"./mat4-7dde83b1.js";import"./vec4f64-939de194.js";import"./byteSizeEstimations-90c5a50d.js";import"./quatf64-c94bd656.js";import"./mat4f64-fbeb2cd1.js";import"./vec2f64-30dc1443.js";import"./preload-helper-41c905a7.js";import"./Polyline-b571c705.js";import"./Extent-a1a1de42.js";import"./utils-52ad3c09.js";import"./jsonUtils-c6684c52.js";import"./generateRendererUtils-2f0b667c.js";import"./jsonMap-190c5593.js";import"./colorRamps-8d7efc14.js";import"./Color-af6e0c66.js";import"./colorUtils-639f4d25.js";import"./enumeration-61a13175.js";import"./Symbol-8266348e.js";import"./ItemCache-bf1028d4.js";import"./MemCache-1d2f56ee.js";import"./WhereClause-6c9440a1.js";import"./utils-44a68fd6.js";import"./unitUtils-dd6fb8ee.js";import"./projection-acd73147.js";import"./SimpleObservable-8e532943.js";import"./assets-cd44347b.js";import"./request-24011425.js";import"./aaBoundingRect-b340cf8c.js";import"./zscale-48bab05e.js";import"./normalizeUtils-0f537694.js";import"./geometry-eec1b371.js";import"./typeUtils-cd52dc20.js";import"./featureConversionUtils-d2229ed4.js";import"./OptimizedFeature-73582c6e.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./json-48e3ea08.js";import"./fieldUtils-b2df74c4.js";import"./arcadeOnDemand-a976a73c.js";import"./plane-46a8c767.js";import"./Util-289ce3b5.js";import"./deduplicate-d92c3cc2.js";import"./InterleavedLayout-b5930508.js";import"./BufferView-478024d2.js";import"./vec2-ab9f47bf.js";import"./types-e1c0a5bf.js";import"./VertexAttribute-9c5c630d.js";import"./glUtil-7aa58841.js";import"./enums-64ab819c.js";import"./VertexElementDescriptor-2925c6af.js";const T=1e3;function N(t,o,i){const n=S(),e=f(n);return l(e,e,t,.5),l(e,e,o,.5),n[3]=u(e,t),h(e,e,i),n}let g=class{constructor(){this._idToComponent=new Map,this._components=new E(t=>t.bounds),this._edges=new E(t=>t.bounds),this._tmpLineSegment=j(),this._tmpP1=d(),this._tmpP2=d(),this._tmpP3=d(),this.remoteClient=null}async fetchCandidates(t,o){await Promise.resolve(),V(o),await this._ensureEdgeLocations(t,o);const i=[];return this._edges.forEachNeighbor(n=>(this._addCandidates(t,n,i),i.length<T),t.bounds),{result:{candidates:i}}}async _ensureEdgeLocations(t,o){const i=[];if(this._components.forEachNeighbor(r=>{if(_(r.info)){const{id:m,uid:s}=r;i.push({id:m,uid:s})}return!0},t.bounds),!i.length)return;const n={components:i},e=await this.remoteClient.invoke("fetchAllEdgeLocations",n,L(o,{}));for(const r of e.components)this._setFetchEdgeLocations(r)}async add(t){const o=new a(t.id,t.bounds);return this._idToComponent.set(o.id,o),this._components.add([o]),{result:{}}}async remove(t){const o=this._idToComponent.get(t.id);if(o){const i=[];this._edges.forEachNeighbor(n=>(n.component===o&&i.push(n),!0),o.bounds),this._edges.remove(i),this._components.remove([o]),this._idToComponent.delete(o.id)}return{result:{}}}_setFetchEdgeLocations(t){const o=this._idToComponent.get(t.id);if(_(o)||t.uid!==o.uid)return;const i=I.createView(t.locations),n=new Array(i.count),e=d(),r=d();for(let p=0;p<i.count;p++){i.position0.getVec(p,e),i.position1.getVec(p,r);const x=N(e,r,t.origin),y=new k(o,p,x);n[p]=y}this._edges.add(n);const{objectIds:m,origin:s}=t;o.info={locations:i,objectIds:m,origin:s}}_addCandidates(t,o,i){const{locations:n,origin:e,objectIds:r}=o.component.info,m=n.position0.getVec(o.index,this._tmpP1),s=n.position1.getVec(o.index,this._tmpP2);h(m,m,e),h(s,s,e);const p=r[n.componentIndex.get(o.index)];this._addEdgeCandidate(t,p,m,s,i),this._addVertexCandidate(t,p,m,i),this._addVertexCandidate(t,p,s,i)}_addEdgeCandidate(t,o,i,n,e){if(!(t.types&C.EDGE))return;const r=f(t.bounds),m=$(i,n,this._tmpLineSegment),s=P(m,r,this._tmpP3);if(!b(t.bounds,s))return null;e.push({type:"edge",objectId:o,target:c(s),distance:u(r,s),start:c(i),end:c(n)})}_addVertexCandidate(t,o,i,n){if(!(t.types&C.VERTEX))return;const e=f(t.bounds);if(!b(t.bounds,i))return null;n.push({type:"vertex",objectId:o,target:c(i),distance:u(e,i)})}};g=w([v("esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorker")],g);const Jt=g;class a{constructor(o,i){this.id=o,this.bounds=i,this.info=null,this.uid=++a.uid}}a.uid=0;class k{constructor(o,i,n){this.component=o,this.index=i,this.bounds=n}}export{Jt as default};
