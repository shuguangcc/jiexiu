import{l as L}from"./Color-af6e0c66.js";import{U as j}from"./request-f17a8ddb.js";import{f as X}from"./typedArrayUtil-d9bc5fbd.js";import{f as q}from"./promiseUtils-32d9c228.js";import{u as A}from"./screenUtils-90993e16.js";import{s as B,i as K,b as W,W as Q,T as V,m as Z,O as $}from"./cimAnalyzer-020551ab.js";import{o as tt,c as et}from"./Rasterizer-2d27c5c3.js";import{G as it,c as at,t as u,r as N}from"./utils-0c7f5071.js";import{m as rt}from"./utils-4aa03157.js";import{A as ot}from"./symbols-75e7a993.js";import"./colorUtils-639f4d25.js";import"./mathUtils-57aba1ea.js";import"./vec3-1863987c.js";import"./vec3f64-6cd30318.js";import"./common-c186b691.js";import"./vec4-46a9b36d.js";import"./ensureType-25b8cc06.js";import"./string-480f3e3f.js";import"./Error-57322e92.js";import"./preload-helper-101896b7.js";import"./fontUtils-4ed0e787.js";import"./arcadeOnDemand-5175e7d9.js";import"./geometry-eec1b371.js";import"./Extent-a1a1de42.js";import"./cast-a534ae90.js";import"./nextTick-3ee5a785.js";import"./Polyline-b571c705.js";import"./typeUtils-cd52dc20.js";import"./jsonMap-190c5593.js";import"./BidiEngine-836b7ef6.js";import"./aaBoundingRect-b340cf8c.js";import"./jsonUtils-c6684c52.js";import"./enums-4b2a86a0.js";import"./alignmentUtils-ae955d28.js";import"./definitions-2d0dd0cd.js";import"./mat2d-d0b91e3e.js";import"./vec2-ab9f47bf.js";import"./vec2f32-461e65a9.js";import"./number-954e4ab6.js";import"./Rect-ea14f53a.js";import"./callExpressionWithFeature-13fe9b68.js";import"./utils-52ad3c09.js";import"./generateRendererUtils-2f0b667c.js";import"./colorRamps-8d7efc14.js";import"./enumeration-61a13175.js";import"./Symbol-8266348e.js";import"./GeometryUtils-eebff0a0.js";import"./floatRGBA-090399ba.js";import"./_commonjsHelpers-a430e9ea.js";import"./imageutils-2739f106.js";import"./rasterizingUtils-22a741bf.js";import"./asyncUtils-087555fc.js";import"./BlendLayer-813950f9.js";import"./parser-01f6451e.js";import"./mat4f32-77b3d8ac.js";import"./mat4-7dde83b1.js";import"./assets-a5ce5e1a.js";import"./ItemCache-bf1028d4.js";import"./MemCache-1d2f56ee.js";import"./CIMSymbol-8f02a6e3.js";import"./fieldUtils-77ec75e2.js";import"./opacityUtils-1333f803.js";import"./symbolLayerUtils3D-c8c40895.js";import"./aaBoundingBox-4a83dbbc.js";import"./persistableUrlUtils-56d43b12.js";import"./Collection-7c37b74e.js";import"./Evented-cbf5f368.js";import"./SimpleObservable-8e532943.js";import"./collectionUtils-0365f48b.js";import"./Portal-51616380.js";import"./Loadable-46524a7e.js";import"./Promise-368b703a.js";import"./locale-30120714.js";import"./PortalGroup-d495847c.js";import"./PortalUser-e16fc7d1.js";import"./Clonable-9b34e760.js";var J;(function(d){d.Legend="legend",d.Preview="preview"})(J||(J={}));const Y=d=>d&&d.scaleFactor?d.scaleFactor:1,st=96/72;class ke{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._imageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new B,this._cimResourceManager=new tt,this._rasterizer=new et(this._cimResourceManager)}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,t,o,a,i,r,m,s){if(!e)return null;const{data:c}=e;if(!c||c.type!=="CIMSymbolReference"||!c.symbol)return null;const{symbol:_}=c;r||(r=it(_));const v=await K.resolveSymbolOverrides(c,t,this._spatialReference,i,r,m,s);this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const p=this._imageDataCanvas,h=this._cimResourceManager,f=[];W.fetchResources(v,h,f),f.length>0&&await Promise.all(f);const{width:l,height:g}=o,C=nt(r,l,g,a),n=W.getEnvelope(v,C,h);if(!n)return null;const D=(window.devicePixelRatio||1)*st;let z=1,k=0,x=0;switch(_.type){case"CIMPointSymbol":case"CIMTextSymbol":{let M=1;n.width>l&&(M=l/n.width);let P=1;n.height>g&&(P=g/n.height),a==="preview"&&(n.width<l&&(M=l/n.width),n.height<g&&(P=g/n.height)),z=Math.min(M,P),k=n.x+n.width/2,x=n.y+n.height/2}break;case"CIMLineSymbol":{let M=1;n.height>g&&(M=g/n.height),z=M,x=n.y+n.height/2;const P=n.x*z+l/2,y=(n.x+n.width)*z+l/2;if(P<0){const{paths:w}=C;w[0][0][0]-=P}if(y>l){const{paths:w}=C;w[0][2][0]-=y-l}}break;case"CIMPolygonSymbol":{k=n.x+n.width/2,x=n.y+n.height/2;const M=n.x*z+l/2,P=(n.x+n.width)*z+l/2,y=n.y*z+g/2,w=(n.y+n.height)*z+g/2,{rings:R}=C;M<0&&(R[0][0][0]-=M,R[0][3][0]-=M,R[0][4][0]-=M),y<0&&(R[0][0][1]+=y,R[0][1][1]+=y,R[0][4][1]+=y),P>l&&(R[0][1][0]-=P-l,R[0][2][0]-=P-l),w>g&&(R[0][2][1]+=w-g,R[0][3][1]+=w-g)}}p.width=l*D,p.height=g*D;const I=1;p.width+=2*I,p.height+=2*I;const S=p.getContext("2d"),b=$.createIdentity();return b.translate(-k,-x),b.scale(z*D,-z*D),b.translate(l*D/2+I,g*D/2+I),S.clearRect(0,0,p.width,p.height),new Q(S,h,b,!0).drawSymbol(v,C),S.getImageData(0,0,p.width,p.height)}async analyzeCIMSymbol(e,t,o,a,i){const r=[],m=t?{geometryType:a,spatialReference:this._spatialReference,fields:t}:null;let s;await V(e.data,m,this._cimResourceManager,r,this._avoidSDF),q(i);for(const c of r)c.cim.type!=="CIMPictureMarker"&&c.cim.type!=="CIMPictureFill"&&c.cim.type!=="CIMPictureStroke"||(s||(s=[]),s.push(this._fetchPictureMarkerResource(c,i))),o&&c.type==="text"&&typeof c.text=="string"&&c.text.includes("[")&&(c.text=at(o,c.text,c.cim.textCase));return s&&await Promise.all(s),r}rasterizeCIMSymbol3D(e,t,o,a,i,r){const m=[];for(const s of e){a&&typeof a.scaleFactor=="function"&&(a.scaleFactor=a.scaleFactor(t,i,r));const c=this._getRasterizedResource(s,t,o,a,i,r);if(!c)continue;let _=0,v=c.anchorX||0,p=c.anchorY||0,h=!1,f=0,l=0;if(o==="esriGeometryPoint"){const g=Y(a);if(f=u(s.offsetX,t,i,r)*g||0,l=u(s.offsetY,t,i,r)*g||0,s.type==="marker")_=u(s.rotation,t,i,r)||0,h=!!s.rotateClockwise&&s.rotateClockwise;else if(s.type==="text"){if(_=u(s.angle,t,i,r)||0,s.horizontalAlignment!==void 0)switch(s.horizontalAlignment){case"left":v=-.5;break;case"right":v=.5;break;default:v=0}if(s.verticalAlignment!==void 0)switch(s.verticalAlignment){case"top":p=.5;break;case"bottom":p=-.5;break;case"baseline":p=-.25;break;default:p=0}}}c!=null&&m.push({angle:_,rotateClockWise:h,anchorX:v,anchorY:p,offsetX:f,offsetY:l,rasterizedResource:c})}return this.getSymbolImage(m)}getSymbolImage(e){const t=document.createElement("canvas"),o=X(t.getContext("2d"));let a=0,i=0,r=0,m=0;const s=[];for(let p=0;p<e.length;p++){const h=e[p],f=h.rasterizedResource;if(!f)continue;const l=f.size,g=h.offsetX,C=h.offsetY,n=h.anchorX,D=h.anchorY,z=h.rotateClockWise||!1;let k=h.angle,x=A(g)-l[0]*(.5+n),I=A(C)-l[1]*(.5+D),S=x+l[0],b=I+l[1];if(k){z&&(k=-k);const y=Math.sin(k*Math.PI/180),w=Math.cos(k*Math.PI/180),R=x*w-I*y,T=x*y+I*w,F=x*w-b*y,O=x*y+b*w,H=S*w-b*y,E=S*y+b*w,G=S*w-I*y,U=S*y+I*w;x=Math.min(R,F,H,G),I=Math.min(T,O,E,U),S=Math.max(R,F,H,G),b=Math.max(T,O,E,U)}a=x<a?x:a,i=I<i?I:i,r=S>r?S:r,m=b>m?b:m;const M=o.createImageData(f.size[0],f.size[1]);M.data.set(new Uint8ClampedArray(f.image.buffer));const P={offsetX:g,offsetY:C,rotateClockwise:z,angle:k,rasterizedImage:M,anchorX:n,anchorY:D};s.push(P)}t.width=r-a,t.height=m-i;const c=-a,_=m;for(let p=0;p<s.length;p++){const h=s[p],f=this._imageDataToCanvas(h.rasterizedImage),l=h.rasterizedImage.width,g=h.rasterizedImage.height,C=c-l*(.5+h.anchorX),n=_-g*(.5-h.anchorY);if(h.angle){const D=(360-h.angle)*Math.PI/180;o.save(),o.translate(A(h.offsetX),-A(h.offsetY)),o.translate(c,_),o.rotate(D),o.translate(-c,-_),o.drawImage(f,C,n),o.restore()}else o.drawImage(f,C+A(h.offsetX),n-A(h.offsetY))}const v=new ot({x:c/t.width-.5,y:_/t.height-.5});return{imageData:t.width!==0&&t.height!==0?o.getImageData(0,0,t.width,t.height):o.createImageData(1,1),anchorPosition:v}}async _fetchPictureMarkerResource(e,t){const o=e.materialHash;if(!this._pictureMarkerCache.get(o)){const a=(await j(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(o,a)}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,o=X(t.getContext("2d"));return t.width=e.width,t.height=e.height,o.putImageData(e,0,0),t}_imageTo32Array(e,t,o,a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const i=this._imageDataCanvas,r=X(i.getContext("2d"));if(i.width=t,i.height=o,r.drawImage(e,0,0,t,o),a){r.save();const m=new L(a);r.fillStyle=m.toHex(),r.globalCompositeOperation="multiply",r.fillRect(0,0,t,o),r.globalCompositeOperation="destination-atop",r.drawImage(e,0,0,t,o),r.restore()}return new Uint32Array(r.getImageData(0,0,t,o).data.buffer)}_getRasterizedResource(e,t,o,a,i,r){let m,s,c;if(e.type==="text")return this._rasterizeTextResource(e,t,a,i,r);({analyzedCIM:m,hash:s}=ct(e,t,i,r));const p=Y(a);if(e.cim.type==="CIMPictureMarker"){const l=u(e.size,t,i,r)*p,{image:g,width:C,height:n}=X(this._getPictureResource(e,l,u(e.color,t,i,r)));return c={image:g,size:[C,n],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},c}rt(m,p,{preserveOutlineWidth:!1});const h=m;s+=o,a&&(s+=JSON.stringify(a));const f=this._resourceCache;return f.has(s)?f.get(s):(c=this._rasterizer.rasterizeJSONResource({cim:h,type:e.type,url:e.url,mosaicHash:s,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF),f.set(s,c),c)}_rasterizeTextResource(e,t,o,a,i){const r=Y(o),m=u(e.text,t,a,i);if(!m||m.length===0)return null;const s=u(e.fontName,t,a,i),c=u(e.style,t,a,i),_=u(e.weight,t,a,i),v=u(e.decoration,t,a,i),p=u(e.size,t,a,i)*r,h=u(e.horizontalAlignment,t,a,i),f=u(e.verticalAlignment,t,a,i),l=N(u(e.color,t,a,i)),g=N(u(e.outlineColor,t,a,i)),C={color:l,size:p,horizontalAlignment:h,verticalAlignment:f,font:{family:s,style:c,weight:_,decoration:v},halo:{size:u(e.outlineSize,t,a,i)||0,color:g,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(m,C)}_getPictureResource(e,t,o){const a=this._pictureMarkerCache.get(e.materialHash);if(!a)return null;const i=a.height/a.width,r=t?i>1?A(t):A(t)/i:a.width,m=t?i>1?A(t)*i:A(t):a.height;return{image:this._imageTo32Array(a,r,m,o),width:r,height:m}}}function nt(d,e,t,o){const i=-e/2+1,r=e/2-1,m=t/2-1,s=-t/2+1;switch(d){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[i,0],[0,0],[r,0]]]};default:return o==="legend"?{rings:[[[i,m],[r,0],[r,s],[i,s],[i,m]]]}:{rings:[[[i,m],[r,m],[r,s],[i,s],[i,m]]]}}}function ct(d,e,t,o){let a,i;return typeof d.materialHash=="function"?(a=(0,d.materialHash)(e,t,o),i=Z(d.cim,d.materialOverrides)):(a=d.materialHash,i=d.cim),{analyzedCIM:i,hash:a}}export{ke as CIMSymbolRasterizer,J as GeometryStyle};
