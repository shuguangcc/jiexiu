import"./TileStrategy-a5366189.js";import"./TileStore-8f580dbf.js";import{e as Li}from"./TileKey-9cae9369.js";import{c as Xt,h as Pi,o as rt,f as Ti,j as je,a as C,k as zi,g as $i,p as Ii,n as it,i as Wi,l as Ci,e as $,m as qe,X as Ei,q as Ai,t as Qe,u as kt,v as Je}from"./definitions-2d0dd0cd.js";import{f as Ri,p as Fi}from"./visualVariablesUtils-c668eb89.js";import{E as P,S as Bt}from"./enums-4ca4641f.js";import{G as Ut,c as H,f as I,e as ki,t as Bi}from"./Utils-a4216b91.js";import{l as Vi}from"./tileUtils-dbff68ee.js";import"./string-480f3e3f.js";import{o as Di,t as V,r as E,e as se,i as Ct}from"./typedArrayUtil-d9bc5fbd.js";import{D as Oi,f as ne,j as Gi,p as be}from"./promiseUtils-32d9c228.js";import{n as ti,r as Zi,c as Ki,i as Ni}from"./TileClipper-9381cfab.js";import{a as st,s as mt}from"./Error-57322e92.js";import{a as ei}from"./mathUtils-57aba1ea.js";import{u as x,o as Xi}from"./screenUtils-90993e16.js";import{c as B,o as bt,e as Se}from"./enums-4b2a86a0.js";import{s as Ui,r as ii,n as ri,i as Hi,a as Yi,c as ji,o as qi}from"./alignmentUtils-ae955d28.js";import{x as F,w as M}from"./number-954e4ab6.js";import{U as Ht,Z as Qi,N as oe,C as Et,w as ft,O as At,b as si,P as Ji,f as ae}from"./MaterialKey-a0a08f8b.js";import{g as tr,d as er,j as ir,f as Kt,n as Le,m as rr,T as sr}from"./cimAnalyzer-020551ab.js";import{G as le,n as he}from"./featureConversionUtils-d2229ed4.js";import{n as ce,f as nr,e as or}from"./mat2d-d0b91e3e.js";import{t as ar,n as ue}from"./vec2f32-461e65a9.js";import{r as St,z as Lt}from"./vec2-ab9f47bf.js";import{r as Pe,s as Te,y as ze}from"./defaultsJSON-59981e75.js";import{M as Yt}from"./GeometryUtils-c093d234.js";import"./earcut-58237617.js";import{t as lr}from"./OptimizedFeature-73582c6e.js";import{s as ni}from"./Geometry-daada628.js";import{t as Pt}from"./utils-0c7f5071.js";import{_ as oi}from"./preload-helper-101896b7.js";import{e as hr}from"./LRUCache-b9228ca3.js";import{o as cr}from"./arcadeOnDemand-5175e7d9.js";import{i as ur}from"./callExpressionWithFeature-13fe9b68.js";import{l as fr}from"./ExpandedCIM-5a2216e6.js";import{c as _r,a as mr}from"./devEnvironmentUtils-5002a058.js";import{j as dr}from"./request-f17a8ddb.js";import{j as pr}from"./Portal-51616380.js";import{c as yr}from"./persistableUrlUtils-56d43b12.js";import{c as xr,w as gr,b as ai,p as li,d as Mr}from"./styleUtils-015eeecd.js";function k(n,t){if(n&&"name"in n){const e=n;return t&&t.error(new st(e.name,e.message,e.details)),!1}return!0}const vr=1.25;let Tt=class{constructor(t,e){this._pos=0;const i=e?this._roundToNearest(e,t.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(i),this._buffer=new t(this._array),this._ctor=t,this._i16View=new Int16Array(this._array)}get length(){return this._pos}_roundToNearest(t,e){const i=Math.round(t);return i+(e-i%e)}_ensureSize(t){if(this._pos+t>=this._buffer.length){const e=this._roundToNearest((this._array.byteLength+t*this._buffer.BYTES_PER_ELEMENT)*vr,this._buffer.BYTES_PER_ELEMENT),i=new ArrayBuffer(e),r=new this._ctor(i);r.set(this._buffer,0),this._array=i,this._buffer=r,this._i16View=new Int16Array(this._array)}}ensureSize(t){this._ensureSize(t)}writeF32(t){this._ensureSize(1);const e=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=t,this._pos++,e}push(t){this._ensureSize(1);const e=this._pos;return this._buffer[this._pos++]=t,e}writeFixed(t){this._buffer[this._pos++]=t}setValue(t,e){this._buffer[t]=e}i1616Add(t,e,i){this._i16View[2*t]+=e,this._i16View[2*t+1]+=i}getValue(t){return this._buffer[t]}incr(t){if(this._buffer.length<t)throw new Error("Increment index overflows the target buffer");this._buffer[t]++}decr(t){this._buffer[t]--}writeRegion(t){this._ensureSize(t.length);const e=this._pos;return this._buffer.set(t,this._pos),this._pos+=t.length,e}writeManyFrom(t,e,i){this._ensureSize(i-e);for(let r=e;r!==i;r++)this.writeFixed(t._buffer[r])}buffer(){const t=this._array.slice(0,4*this._pos);return this.destroy(),t}toArray(){const t=this._array,e=[];for(let i=0;i<t.byteLength/4;i++)e.push(t[i]);return e}seek(t){this._pos=t}destroy(){this._array=null,this._buffer=null}};const ct=new Map;function wr(n,t,e){const{indicesPerRecord:i,multiplier:r,verticesPerRecord:s}=ct.get(n);return{recordBytes:e*Xt*Uint32Array.BYTES_PER_ELEMENT,indexBytes:r*i*e*Uint32Array.BYTES_PER_ELEMENT,vertexBytes:r*s*e*t}}ct.set(P.MARKER,{multiplier:1,indicesPerRecord:6,verticesPerRecord:4}),ct.set(P.LINE,{multiplier:1,indicesPerRecord:24,verticesPerRecord:8}),ct.set(P.FILL,{multiplier:1,indicesPerRecord:10,verticesPerRecord:10}),ct.set(P.TEXT,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4}),ct.set(P.LABEL,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4});let $e=class{constructor(t,e,i){this._start={index:0,vertex:0};const r=wr(t,e,i),s=e/4;this.geometryType=t,this._records=new Tt(Int32Array,r.recordBytes),this._indices=new Tt(Uint32Array,r.indexBytes),this._vertices=new Tt(Uint32Array,r.vertexBytes),this._metrics=new Tt(Float32Array,0),this._strideInt=s}serialize(t){const e=this._records.buffer(),i=this._indices.buffer(),r=this._vertices.buffer(),s=this._metrics.length?this._metrics.buffer():null,o=4*this._strideInt;return t.push(e,i,r),{stride:o,records:e,indices:i,vertices:r,metrics:s}}get strideInt(){return this._strideInt}get recordCount(){return this._records.length/Xt}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(t){this._vertices.ensureSize(t)}indexEnsureSize(t){this._indices.ensureSize(t)}recordStart(){this._start.index=this._indices.length,this._start.vertex=this._vertices.length}recordEnd(t,e,i,r,s,o,a,l){this._records.push(t),this._records.push(e),this._records.push(i),this._records.push(r),this._records.push(s),this._records.push(o),this._records.push(a),this._records.writeF32(l)}writeIndex(t){this._indices.push(t)}writeVertex(t){this._vertices.push(t)}writeVertexF32(t){this._vertices.writeF32(t)}copyLastFrom(t,e,i){const r=t._records.length-Xt,s=t._records.getValue(r),o=t._records.getValue(r+1),a=t._records.getValue(r+2),l=t._records.getValue(r+4),h=t._records.getValue(r+6),u=t._records.getValue(r+7),c=this._vertices.length,_=(t._start.vertex-this._vertices.length)/this._strideInt,f=this._indices.length,d=this.vertexCount;for(let m=t._start.index;m!==t._indices.length;m++){const y=t._indices.getValue(m);this._indices.push(y-_)}for(let m=t._start.vertex;m!==t._vertices.length;m++){const y=t._vertices.getValue(m);this._vertices.push(y)}for(let m=c;m<=this._vertices.length;m+=this._strideInt)this._vertices.i1616Add(m,e,i);this._records.push(s),this._records.push(o),this._records.push(a),this._records.push(f),this._records.push(l),this._records.push(d),this._records.push(h),this._records.push(u)}};const Vt=1,fe=2,Dt=4,_e=8,me=16,Ot=32,de=64,Gt=128;function Ie(n){switch(n){case Vt:case _e:case Ot:return-1;case fe:case de:return 0;case Dt:case me:case Gt:return 1}}function We(n){switch(n){case Vt:case fe:case Dt:return-1;case _e:case me:return 0;case Ot:case de:case Gt:return 1}}const Ce=Vt|_e|Ot,Ee=Dt|me|Gt,Ae=Vt|fe|Dt,Re=Ot|de|Gt;let pn=class{constructor(t,e,i,r,s,o=0){this._hasAggregate=!1,this.hasRecords=!1,this._data={self:new Map,neighbors:new Array},this._version=0,this._current={geometryType:0,writer:null,overlaps:0,start:0,insertAfter:0,sortKey:0,id:0,materialKey:0,indexStart:0,vertStart:0,isDotDensity:!1,bufferingEnabled:!1,metricBoxLenPointer:0},this.hint=e,this.tileKey=t,this._hasAggregate=r,this._pixelBufferEnabled=s,this._version=o,this._symbologyType=i}get hasAggregates(){return this._hasAggregate}get hasPixelBufferEnabled(){return this._pixelBufferEnabled}serialize(t){const e=[];return e.push(this._serializeTileVertexData(this.tileKey,this.tileKey,this._data.self)),this._data.neighbors.forEach((i,r)=>{const s=1<<r,o=Ie(s),a=We(s),l=Vi(new Li(this.tileKey),o,a,t),h=this._serializeTileVertexData(this.tileKey,l.id,i.vertexData);h.message.bufferIds=i.displayIds,e.push(h)}),e}_serializeTileVertexData(t,e,i){var s,o,a,l,h;const r=new Array;return{message:{tileKeyOrigin:t,tileKey:e,data:{[P.MARKER]:(s=i.get(P.MARKER))==null?void 0:s.serialize(r),[P.FILL]:(o=i.get(P.FILL))==null?void 0:o.serialize(r),[P.LINE]:(a=i.get(P.LINE))==null?void 0:a.serialize(r),[P.TEXT]:(l=i.get(P.TEXT))==null?void 0:l.serialize(r),[P.LABEL]:(h=i.get(P.LABEL))==null?void 0:h.serialize(r)},version:this._version},transferList:r}}featureStart(t,e){this._current.insertAfter=t,this._current.sortKey=e}featureEnd(){}recordStart(t,e,i,r){this._current.writer=this._getVertexWriter(i),this._current.overlaps=0,this._current.indexStart=this._current.writer.indexCount,this._current.vertStart=this._current.writer.vertexCount,this._current.bufferingEnabled=r,this._current.id=t,this._current.materialKey=e,this._current.geometryType=i,this._current.isDotDensity=!1,this._current.writer.recordStart()}recordCount(){return this._current.writer.recordCount}vertexCount(){return this._current.writer.vertexCount}indexCount(){return this._current.writer.indexCount}vertexEnsureSize(t){this._current.writer.vertexEnsureSize(t)}indexEnsureSize(t){this._current.writer.indexEnsureSize(t)}vertexBounds(t,e,i,r){this._current.bufferingEnabled&&this._addOverlap(t,e,i,r)}vertexWrite(t){this._current.writer.writeVertex(t)}vertexWriteF32(t){this._current.writer.writeVertexF32(t)}vertexEnd(){}vertexWriter(){return this._current.writer.vertexWriter}indexWrite(t){this._current.writer.writeIndex(t)}indexWriter(){return this._current.writer.indexWriter}metricWriter(){return this._current.writer.metricWriter}metricStart(t,e,i,r,s,o,a,l){this._current.writer=this._getVertexWriter(P.LABEL);const h=this._current.writer.metricWriter;h.push(Ri(t)),h.push(e),h.push(i),h.push(r),h.push(s),h.push(o),h.push(a),h.push(l),h.push(255),this._current.metricBoxLenPointer=h.push(0)}metricEnd(){const t=this._current.writer.metricWriter;t.getValue(this._current.metricBoxLenPointer)===0&&t.seek(t.length-10)}metricBoxWrite(t,e,i,r){const s=this._current.writer.metricWriter;s.incr(this._current.metricBoxLenPointer),s.push(0),s.push(0),s.push(t),s.push(e),s.push(i),s.push(r)}recordEnd(){const t=this._current.vertStart,e=this._current.writer.vertexCount-t;if(!e)return!1;this.hasRecords=!0;const i=this._current.indexStart,r=this._current.writer.indexCount-i;if(this._current.writer.recordEnd(this._current.id,this._current.materialKey,this._current.insertAfter,i,r,t,e,this._current.sortKey),!this._pixelBufferEnabled||this._hasAggregate||this._current.overlaps===0||this._current.geometryType===P.LABEL)return!0;const s=this._current.writer;for(let o=0;o<8;o++){const a=1<<o;if(this._current.overlaps&a){this._data.neighbors[o]||(this._data.neighbors[o]={vertexData:new Map,displayIds:new Set});const l=this._data.neighbors[o],h=this._current.geometryType;if(!l.vertexData.has(h)){const d=Ut(h,this._symbologyType).geometry,m=new $e(h,d,Pi);l.vertexData.set(h,m)}const u=l.vertexData.get(this._current.geometryType),c=8,_=512*-Ie(a)*c,f=512*-We(a)*c;u.copyLastFrom(s,_,f),l.displayIds.add(this._current.id)}}return!0}_addOverlap(t,e,i,r){const s=255^((t<0+i?Ee:t>=rt-i?Ce:Ee|Ce)|(e<0+r?Re:e>=rt-r?Ae:Re|Ae));this._current.overlaps|=s}_getVertexWriter(t){if(!this._data.self.has(t)){const e=this._data.self,i=Ut(t,this._symbologyType).geometry;e.set(t,new $e(t,i,this.hint.records))}return this._data.self.get(t)}};const O=0,G=100;function Fe(n,t,e){return n[0]=t[0]-e[0],n[1]=t[1]-e[1],n}function hi(n,t){return Math.sqrt(n*n+t*t)}function ke(n){const t=hi(n[0],n[1]);n[0]/=t,n[1]/=t}function br(n,t){return hi(n[0]-t[0],n[1]-t[1])}function w(n){return typeof n=="function"}function jt(n=2){return 1/Math.max(n,1)}function J(n,t){return[!!n.minScale&&t.scaleToZoom(n.minScale)||O,!!n.maxScale&&t.scaleToZoom(n.maxScale)||G]}function Sr(n,t){return n[t+1]}function ci(n){return n.length-1}function Lr(n){let t=0;for(let e=0;e<ci(n);e++)t+=Pr(n,e);return t}function Pr(n,t,e=1){const[i,r]=Sr(n,t);return Math.sqrt(i*i+r*r)*e}let qt=class{constructor(t,e,i,r,s){this._segments=t,this._index=e,this._distance=i,this._xStart=r,this._yStart=s,this._done=!1}static create(t){return new qt(t,0,0,t[0][0],t[0][1])}clone(){return new qt(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(this._distance===0||t._distance===1)||t._index===this._index+1&&(this._distance===1||t._distance===0)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,e=(0*t+-1*-this.dx)/(1*this.length);let i=Math.acos(e);return t>0&&(i=2*Math.PI-i),i}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:e}=this;return Math.sqrt(t*t+e*e)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<ci(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,e){const i=this.backwardLength;if(t<=i)return this._distance=(i-t)/this.length,this;let r=this.backwardLength;for(;this.prev();){if(r+this.length>t)return this._seekBackwards(t-r);r+=this.length}return this._distance=0,e?this:null}seek(t,e=!1){if(t<0)return this._seekBackwards(Math.abs(t),e);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let i=this.remainingLength;for(;this.next();){if(i+this.length>t)return this.seek(t-i,e);i+=this.length}return this._distance=1,e?this:null}};function Tr(n,t,e,i=!0){const r=Lr(n),s=qt.create(n),o=r/2;if(!i)return s.seek(o),void e(s.clone(),0,o+0*t,r);const a=Math.max((r-t)/2,0),l=Math.floor(a/t),h=o-l*t;s.seek(h);for(let u=-l;u<=l;u++)s.x<512&&s.x>=0&&s.y<512&&s.y>=0&&e(s.clone(),u,o+u*t,r),s.seek(t)}function zr(n,t){const e=t;for(let i=0;i<n.length;i++){let r=n[i];const s=[];s.push(r[0]);for(let a=1;a<r.length;a++){let[l,h]=s[a-1];l+=r[a][0],h+=r[a][1],s.push([l,h])}$r(s,e);const o=[];o.push(s[0]);for(let a=1;a<s.length;a++){const[l,h]=s[a-1],[u,c]=s[a],_=Math.round(u-l),f=Math.round(c-h);o.push([_,f])}n[i]=o,r=o}return n}function $r(n,t){if(t<=0)return;const i=n.length;if(i<3)return;const r=[];let s=0;r.push(0);for(let c=1;c<i;c++)s+=br(n[c],n[c-1]),r.push(s);t=Math.min(t,.2*s);const o=[];o.push(n[0][0]),o.push(n[0][1]);const a=n[i-1][0],l=n[i-1][1],h=Fe([0,0],n[0],n[1]);ke(h),n[0][0]+=t*h[0],n[0][1]+=t*h[1],Fe(h,n[i-1],n[i-2]),ke(h),n[i-1][0]+=t*h[0],n[i-1][1]+=t*h[1];for(let c=1;c<i;c++)r[c]+=t;r[i-1]+=t;const u=.5*t;for(let c=1;c<i-1;c++){let _=0,f=0,d=0;for(let m=c-1;m>=0&&!(r[m+1]<r[c]-u);m--){const y=u+r[m+1]-r[c],p=r[m+1]-r[m],g=r[c]-r[m]<u?1:y/p;if(Math.abs(g)<1e-6)break;const v=g*g,b=g*y-.5*v*p,L=g*p/t,S=n[m+1],T=n[m][0]-S[0],z=n[m][1]-S[1];_+=L/b*(S[0]*g*y+.5*v*(y*T-p*S[0])-v*g*p*T/3),f+=L/b*(S[1]*g*y+.5*v*(y*z-p*S[1])-v*g*p*z/3),d+=L}for(let m=c+1;m<i&&!(r[m-1]>r[c]+u);m++){const y=u-r[m-1]+r[c],p=r[m]-r[m-1],g=r[m]-r[c]<u?1:y/p;if(Math.abs(g)<1e-6)break;const v=g*g,b=g*y-.5*v*p,L=g*p/t,S=n[m-1],T=n[m][0]-S[0],z=n[m][1]-S[1];_+=L/b*(S[0]*g*y+.5*v*(y*T-p*S[0])-v*g*p*T/3),f+=L/b*(S[1]*g*y+.5*v*(y*z-p*S[1])-v*g*p*z/3),d+=L}o.push(_/d),o.push(f/d)}o.push(a),o.push(l);for(let c=0,_=0;c<i;c++)n[c][0]=o[_++],n[c][1]=o[_++]}let ui=class{static getPlacement(t,e,i,r){const s=tr(e);if(!s)return null;const o=er(t);return s.execute(o,e,i,r)}};const zt=8,fi=n=>class extends n{constructor(...t){super(...t),this._isCIM=!1,this._vertexBoundsScale=1,this.geometryType=P.TEXT,this._aux=F(0,0,this._referenceSize,this._bitset)}bindTextInfo(t,e){t&&t.length?this._shapingInfo=Di(t,i=>ir(i,e,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:Ti*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM})):this._shapingInfo=null}_write(t,e,i,r){const s=e.getDisplayId();this._writeGeometry(t,e,s,i,r)}_writeGeometry(t,e,i,r,s){const o=this._shapingInfo;if(V(o))return;if(E(this._textPlacement)){const l=s??e.readLegacyGeometryForDisplay();return this._writePlacedText(t,i,l,o,r)}const a=s?le(he(s),2):e.geometryType==="esriGeometryPolygon"?e.readCentroid():e.readGeometryForDisplay();if(!V(a)){if(a.isPoint){const[l,h]=a.coords;return!t.hasAggregates&&t.hasPixelBufferEnabled&&(l<0||l>=512||h<0||h>=512)?void 0:this._writeGlyphs(t,i,{x:l,y:h},o)}a.forEachVertex((l,h)=>this._writeGlyphs(t,i,{x:l,y:h},o))}}_writePlacedText(t,e,i,r,s){const o=se(this._textPlacement),a=ui.getPlacement(i,o,x(1),s.geometryEngine);if(!a)return;let l=a.next();for(;l!=null;){const h=-l.getAngle();r.setRotation(h);const u=l.tx,c=-l.ty;u<0||u>=512||c<0||c>=512||(this._writeGlyphs(t,e,{x:u,y:c},r),r.setRotation(-h)),l=a.next()}}_writeGlyphs(t,e,i,r){const s=Ht.load(this._materialKey),o=M(Math.round(zt*i.x),Math.round(zt*i.y)),a=this._vertexBoundsScale,l=r.bounds,h=2*Math.max(l.width,l.height);for(const u of r.glyphs)s.textureBinding=u.textureBinding,t.recordStart(e,s.data,this.geometryType,!0),t.vertexBounds(i.x+l.x+this._xOffset,i.y+l.y-this._yOffset,h*a,h*a),this._writeVertices(t,e,o,u),t.recordEnd()}_writeGlyph(t,e,i,r,s){const o=Ht.load(this._materialKey),a=M(Math.round(zt*i),Math.round(zt*r));o.textureBinding=s.textureBinding,t.recordStart(e,o.data,this.geometryType,!0);const l=s.bounds,h=this._vertexBoundsScale;t.vertexBounds(i+l.x*h,r+l.y*h,l.width*h,l.height*h),this._writeVertices(t,e,a,s),t.recordEnd()}_writeVertices(t,e,i,r){const s=t.vertexCount();this._writeVertexCommon(t,e,i,r),t.vertexWrite(r.offsets.upperLeft),t.vertexWrite(r.texcoords.upperLeft),t.vertexEnd(),this._writeVertexCommon(t,e,i,r),t.vertexWrite(r.offsets.upperRight),t.vertexWrite(r.texcoords.upperRight),t.vertexEnd(),this._writeVertexCommon(t,e,i,r),t.vertexWrite(r.offsets.lowerLeft),t.vertexWrite(r.texcoords.lowerLeft),t.vertexEnd(),this._writeVertexCommon(t,e,i,r),t.vertexWrite(r.offsets.lowerRight),t.vertexWrite(r.texcoords.lowerRight),t.vertexEnd(),t.indexWrite(s+0),t.indexWrite(s+1),t.indexWrite(s+2),t.indexWrite(s+1),t.indexWrite(s+3),t.indexWrite(s+2)}_writeVertexCommon(t,e,i,r){const s=this._color,o=this._haloColor,a=F(0,0,this._referenceSize,this._bitset),l=F(0,0,this._size,this._haloSize);t.vertexWrite(i),t.vertexWrite(e),t.vertexWrite(s),t.vertexWrite(o),t.vertexWrite(l),t.vertexWrite(a),t.vertexWrite(this._minMaxZoom)}};let wt=class{bindFeature(t,e,i){}write(t,e,i,r){var a;if(V(this._effects)||((a=this._effects)==null?void 0:a.length)===0)return this._write(t,e,r);const s=Kt.executeEffects(this._effects,e.readLegacyGeometryForDisplay(),r.geometryEngine);let o=Kt.next(s);for(;o;)this._write(t,e,r,o),o=Kt.next(s)}_write(t,e,i,r){}};const Ir=5;let yt=class extends fi(wt){constructor(t,e,i,r,s,o,a,l,h,u,c,_,f,d,m,y,p,g,v=!1,b,L){super(),this._xOffset=x(f),this._yOffset=x(d),this._decoration=u||"none",this._color=s,this._haloColor=o,this._haloSize=Math.min(Math.floor(Ir*x(Xi(i))),127),this._size=Math.min(Math.round(x(e)),127);const S=Math.min(Math.round(x(r||e)),127);this._referenceSize=Math.round(Math.sqrt(256*S)),this._scale=this._size/je,this._angle=_,this._justify=Ui(a||"center"),this._xAlignD=ii(a||"center"),this._yAlignD=ri(l||"baseline"),this._baseline=(l||"baseline")==="baseline",this._bitset=(h===B.MAP?1:0)|(c?1:0)<<1;const T=Ht.load(t);T.sdf=!0,this._materialKey=T.data,this._lineWidth=x(m)||512,this._lineHeight=y||1,this._textPlacement=p,this._effects=g,this._isCIM=v,this._minMaxZoom=M(Math.round(b*C),Math.round(L*C))}static fromText(t,e){const i=new yt(t.materialKey,t.font.size,t.haloSize||0,t.font.size,t.color&&H(t.color)||0,t.haloColor&&H(t.haloColor)||0,t.horizontalAlignment,t.verticalAlignment,B.SCREEN,t.font.decoration,!1,t.angle||0,t.xoffset,t.yoffset,t.lineWidth,t.lineHeight,null,null,!1,O,G),[,r]=Le(t.text);return i.bindTextInfo(e,r),i._vertexBoundsScale=t.maxVVSize?t.maxVVSize/t.font.size:1,i}static fromCIMText(t,e,i){const r=t.scaleFactor||1,s=t.size*t.sizeRatio*r,[o,a]=J(t.scaleInfo,i),l=new yt(t.materialKey,s,t.outlineSize*t.sizeRatio,t.referenceSize,I(t.color),I(t.outlineColor),t.horizontalAlignment,t.verticalAlignment,t.alignment,t.decoration,t.colorLocked,t.angle,t.offsetX*t.sizeRatio*r,t.offsetY*t.sizeRatio*r,512,1,t.markerPlacement,t.effects,!0,o,a),[,h]=Le(t.text);return l.bindTextInfo(e,h),l._vertexBoundsScale=t.maxVVSize?t.maxVVSize/s:1,l}};const Wr=mt.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),Cr=(n,t="mapview-labeling")=>Wr.error(new st(t,n)),$t=1,at=0,Er=4,Be=25;function Ar(n,t){const e=!!n.minScale&&t.scaleToZoom(n.minScale)||0;return ei(e,0,25.5)}function Rr(n,t){const e=!!n.maxScale&&t.scaleToZoom(n.maxScale)||255;return ei(e,0,25.5)}function Fr(n){const t=new Map;return e=>(t.has(e)||t.set(e,n(e)),t.get(e))}const kr=Fr(n=>{let t=0;if(n===0)return 1/0;for(;!(n%2);)t++,n/=2;return t}),It=n=>Math.floor(127*n+127),dt=n=>Math.floor(10*n),lt=n=>Math.round(n*(254/360));let Qt=class extends yt{constructor(t,e,i,r){super(t,i.font.size,i.haloSize||0,i.font.size,i.color&&H(i.color)||0,i.haloColor&&H(i.haloColor)||0,i.horizontalAlignment,i.verticalAlignment,Hi(e.labelPlacement)?B.MAP:B.SCREEN,i.font.decoration,!1,i.angle||0,i.xoffset,i.yoffset,i.lineWidth,i.lineHeight,null,null,null,null,null),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=P.LABEL,this._allowOverrun=e.allowOverrun??!1,this._repeatLabel=e.repeatLabel??!0,this._labelPosition=e.labelPosition??"curved";const s=Ar(e,r),o=Rr(e,r),a=e.labelPlacement,[l,h]=Yi(a);this._xAlignD=l,this._yAlignD=h,this._minZoom=s,this._maxZoom=o,this._refPlacementPadding=x(i.haloSize)+zi,this._repeatLabelDistance=e.repeatLabelDistance?x(e.repeatLabelDistance):128;const u=Qi.load(t);u.sdf=!0,this._materialKey=u.data}static fromLabelClass(t,e){if(t.labelPlacement==="esriServerLinePlacementCenterAlong"){const i=t.symbol;i.xoffset=0,i.yoffset=0,i.angle=0,i.font.decoration="none"}return new Qt(t.materialKey,t,t.symbol,e)}get _shapedBox(){return se(this._shapingInfo).bounds}setZoomLevel(t){this._zoomLevel=t}bindReferenceTemplate(t){let e=ji(this._xAlignD),i=qi(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,V(t))return void(this._refSymbolAndPlacementOffset=F(0,0,It(e),It(i)));if(t.boundsType==="circle"&&(e||i)){const o=Math.sqrt(e*e+i*i);e/=o,i/=o}const r=Math.max(t.height,t.width),s=this._refPlacementPadding*Er;this._refSymbolAndPlacementOffset=F(s,r,It(e),It(i)),this._referenceSize=r,this._refPlacementDirX=e,this._refPlacementDirY=i,this._refOffsetX=t.xOffset,this._refOffsetY=t.yOffset}_write(t,e){if(V(this._shapingInfo))return;const i=this._shapingInfo,r=e.getDisplayId(),s=e.geometryType==="esriGeometryPolygon"?e.readLegacyCentroid():e.readLegacyGeometry();if(s)switch(this._current={out:t,inId:r,inShaping:i,zoomLevel:this._zoomLevel},e.geometryType){case"esriGeometryPolyline":this._placeLineLabels(s);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(s);break;default:Cr("mapview-labeling",`Geometry of type ${e.geometryType} is not supported`)}}_isVisible(t,e){const i=dt(this._current.zoomLevel);return dt(t)<=i&&i<=dt(e)}_placePointLabels(t){const{out:e,inId:i,inShaping:r}=this._current;this._writeGlyphs(e,i,t,r)}_placeLineLabels(t){const e=zr(t.paths,this._current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),r=(this._shapedBox.width+this._repeatLabelDistance)/(1<<$t);for(const s of e)Tr(s,r,i,this._repeatLabel)}_placeSubdivGlyphs(t,e,i,r){const s=kr(e),o=this._shapedBox.width/(1<<$t),a=Math.sqrt(this._repeatLabelDistance)/(1<<$t),l=Math.min(i,r-i),h=this._current.inShaping.isMultiline?Be:Math.log2(l/(a+o/2)),u=e===0?h:Math.min(s,h),c=Math.max(this._minZoom,this._current.zoomLevel+$t-u),_=this._current.zoomLevel-c,f=this._shapedBox.width/2*2**_;this._current.inShaping.isMultiline?e===0&&this._placeStraight(t,c):this._allowOverrun&&_<0?this._placeStraightAlong(t,this._minZoom):this._labelPosition==="parallel"?this._placeStraightAlong(t,c):this._labelPosition==="curved"&&this._placeCurved(t,c,f)}_placeStraight(t,e){const{out:i,inId:r,inShaping:s}=this._current,o=Math.ceil(t.angle*(180/Math.PI)%360),a=Math.ceil((t.angle*(180/Math.PI)+180)%360);this._outLineLabelAngle=lt(o),this._writeGlyphs(i,r,t,s,e),this._outLineLabelAngle=lt(a),this._writeGlyphs(i,r,t,s,e)}_placeCurved(t,e,i){const{out:r,inId:s}=this._current;r.metricStart(s,e,t.x,t.y,0,0,0,0);const o=t.clone(),a=t.angle*(180/Math.PI)%360,l=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=lt(a),this._placeFirst(o,e,1),this._placeBack(t,o,e,i,1),this._placeForward(t,o,e,i,1),this._outLineLabelAngle=lt(l),this._placeFirst(o,e,0),this._placeBack(t,o,e,i,0),this._placeForward(t,o,e,i,0),r.metricEnd()}_placeStraightAlong(t,e){const{out:i,inId:r}=this._current;i.metricStart(r,e,t.x,t.y,0,0,0,0);const s=t.clone(),o=t.angle*(180/Math.PI)%360,a=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=lt(o),this._placeFirst(s,e,1,!0),this._outLineLabelAngle=lt(a),this._placeFirst(s,e,0,!0),i.metricEnd()}_placeBack(t,e,i,r,s){const o=t.clone();let a=t.backwardLength+at;for(;o.prev()&&!(a>=r);)this._placeOnSegment(o,e,a,i,-1,s),a+=o.length+at}_placeForward(t,e,i,r,s){const o=t.clone();let a=t.remainingLength+at;for(;o.next()&&!(a>=r);)this._placeOnSegment(o,e,a,i,1,s),a+=o.length+at}_placeFirst(t,e,i,r=!1){const s=t,o=this._current.inShaping,a=o.glyphs,l=this._current.zoomLevel,{out:h,inId:u}=this._current;for(const c of a){const _=c.x>o.bounds.x?i:1-i,f=_*t.remainingLength+(1-_)*t.backwardLength,d=Math.abs(c.x+c.width/2-o.bounds.x),m=Math.max(0,l+Math.log2(d/(f+at))),y=Math.max(e,r?0:m);if(c.maxZoom=Be,c.angle=t.angle+(1-i)*Math.PI,c.minZoom=y,this._writeGlyph(h,u,s.x,s.y,c),i&&this._isVisible(c.minZoom,c.maxZoom)){const p=c.bounds;h.metricBoxWrite(p.center[0],p.center[1],p.width,p.height)}}}_placeOnSegment(t,e,i,r,s,o){const a=this._current.inShaping.glyphs,{out:l,inId:h}=this._current,u=this._current.inShaping,c=this._current.zoomLevel,_=t.dx/t.length,f=t.dy/t.length,d={x:t.x+i*-s*_,y:t.y+i*-s*f};for(const m of a){const y=m.x>u.bounds.x?o:1-o;if(!(y&&s===1||!y&&s===-1))continue;const p=Math.abs(m.x+m.width/2-u.bounds.x),g=Math.max(0,c+Math.log2(p/i)-.1),v=Math.max(r,c+Math.log2(p/(i+t.length+at)));if(g!==0&&(m.angle=t.angle+(1-o)*Math.PI,m.minZoom=v,m.maxZoom=g,this._writeGlyph(l,h,d.x,d.y,m),o&&this._isVisible(m.minZoom,m.maxZoom))){const b=m.bounds,L=t.x-e.x,S=t.y-e.y;l.metricBoxWrite(b.center[0]+L,b.center[1]+S,b.width,b.height)}}}_writeGlyphs(t,e,i,r,s=this._minZoom){if(i.x<0||i.x>=512||i.y<0||i.y>=512)return;const o=i.x+this._refOffsetX,a=i.y-this._refOffsetY;for(const c of r.glyphs)c.minZoom=s,c.maxZoom=this._maxZoom,this._writeGlyph(t,e,o,a,c);const l=this._refPlacementDirX,h=this._refPlacementDirY,u=r.boundsT;t.metricStart(e,s,o,a,l,h,this._referenceSize,this._materialKey),t.metricBoxWrite(u.center[0],u.center[1],u.width,u.height),t.metricEnd()}_writeVertexCommon(t,e,i,r){const s=this._color,o=this._haloColor,a=F(0,0,this._size,this._haloSize),l=Math.max(r.minZoom,this._minZoom),h=Math.min(r.maxZoom,this._maxZoom),u=F(dt(l),dt(h),this._outLineLabelAngle,0);t.vertexWrite(i),t.vertexWrite(e),t.vertexWrite(s),t.vertexWrite(o),t.vertexWrite(a),t.vertexWrite(this._refSymbolAndPlacementOffset),t.vertexWrite(u)}};const Ve=3.14159265359/180,De=8,_i=n=>class extends n{constructor(...t){super(...t),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this._vertexBoundsScaleX=1,this._vertexBoundsScaleY=1,this._offsets={xUpperLeft:0,yUpperLeft:0,xUpperRight:0,yUpperRight:0,xBottomLeft:0,yBottomLeft:0,xBottomRight:0,yBottomRight:0},this.geometryType=P.MARKER}_write(t,e,i,r){const s=e.getDisplayId();t.recordStart(s,this._materialKey,this.geometryType,!0),this._writeGeometry(t,e,s,i,r),t.recordEnd()}_writeGeometry(t,e,i,r,s){if(E(this._markerPlacement))return this._writePlacedMarkers(t,e,r,s);if(!s&&e.geometryType==="esriGeometryPoint"){const a=e.getX(),l=e.getY();return!t.hasAggregates&&t.hasPixelBufferEnabled&&(a<0||a>=513||l<0||l>=513)?void 0:this._writeVertices(t,i,this._getPos(a,l),a,l)}const o=s?le(he(s),2):e.geometryType==="esriGeometryPolygon"?e.readCentroid():e.readGeometryForDisplay();if(!V(o)){if(o.isPoint){const[a,l]=o.coords;return!t.hasAggregates&&t.hasPixelBufferEnabled&&(a<0||a>=512||l<0||l>=512)?void 0:this._writeVertices(t,i,this._getPos(a,l),a,l)}o.forEachVertex((a,l)=>{const h=2*rt;a<-h||a>=h||l<-h||l>=h||this._writeVertices(t,i,this._getPos(a,l),a,l)})}}_writePlacedMarkers(t,e,i,r){const s=r??e.readLegacyGeometryForDisplay(),o=ui.getPlacement(s,se(this._markerPlacement),x(1),i.geometryEngine);if(!o)return;const a=e.getDisplayId(),l=ue(),h=ce(),u=-128,c=640;let _=o.next();for(;_!=null;){const f=_.tx,d=-_.ty;f>=u&&f<=c&&d>=u&&d<=c&&(this._applyTransformation(h,l,-_.getAngle()/Ve),this._writeVertices(t,a,this._getPos(f,d),f,d)),_=o.next()}}_writeVertices(t,e,i,r,s){const o=oe.load(this._materialKey);return o.symbologyType===Bt.HEATMAP?this._writeHeatmapVertices(t,e,i):this._writeMarkerVertices(t,e,o,i,r,s)}_writeMarkerVertices(t,e,i,r,s,o){const a=i.vvRotation,l=t.vertexCount();let h=this._computedWidth*this._vertexBoundsScaleX,u=this._computedHeight*this._vertexBoundsScaleY;if(this.angle){const c=Math.max(h,u);h=c,u=c}if(a){const c=Math.max(this.xOffset,this.yOffset);h+=c,u+=c}t.vertexBounds(s+this.xOffset,o-this.yOffset,h,u),t.vertexWrite(r),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(this._texUpperLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(r),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(this._texUpperRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(r),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(this._texBottomLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(r),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(this._texBottomRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),this._writeIndices(t,l)}_writeHeatmapVertices(t,e,i){const r=t.vertexCount();t.vertexWrite(i),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(e),t.vertexEnd(),this._writeIndices(t,r)}_writeIndices(t,e){t.indexWrite(e+0),t.indexWrite(e+1),t.indexWrite(e+2),t.indexWrite(e+1),t.indexWrite(e+3),t.indexWrite(e+2)}_applyTransformation(t,e,i=0){nr(t,ar(this.xOffset,-this.yOffset)),this.angle+i!==0&&or(t,t,Ve*(this.angle+i));const r=this._computedWidth,s=this._computedHeight,o=-(.5+this._anchorX)*r,a=-(.5-this._anchorY)*s;St(e,o,a),Lt(e,e,t),this._offsetUpperLeft=M(16*e[0],16*e[1]),this._offsets.xUpperLeft=e[0],this._offsets.yUpperLeft=e[1],St(e,o+r,a),Lt(e,e,t),this._offsetUpperRight=M(16*e[0],16*e[1]),this._offsets.xUpperRight=e[0],this._offsets.yUpperRight=e[1],St(e,o,a+s),Lt(e,e,t),this._offsetBottomLeft=M(16*e[0],16*e[1]),this._offsets.xBottomLeft=e[0],this._offsets.yBottomLeft=e[1],St(e,o+r,a+s),Lt(e,e,t),this._offsetBottomRight=M(16*e[0],16*e[1]),this._offsets.xBottomRight=e[0],this._offsets.yBottomRight=e[1]}_getPos(t,e){return M(Math.round(De*t),Math.round(De*e))}};let U=class extends _i(wt){constructor(t,e,i,r,s,o,a,l,h,u,c,_,f,d,m,y,p,g,v,b,L,S,T){super(),this.angle=r,this.height=a,this.width=o,this.xOffset=e*v,this.yOffset=i*v,this._markerPlacement=b,this._effects=L,this._anchorX=y,this._anchorY=p,this._minMaxZoom=M(Math.round(S*C),Math.round(T*C));const z=(d===B.MAP?$i:Ii)|(c?it:0)|(f?Wi:0)|(_?Ci:0),K=m&&m.sdf,Y=oe.load(t);Y.sdf=K,Y.pattern=!0,Y.textureBinding=m.textureBinding,this._materialKey=Y.data,this._fillColor=s,this._outlineColor=h,this._sizeOutlineWidth=F(Math.round(Math.min(Math.sqrt(128*o),255)),Math.round(Math.min(Math.sqrt(128*a),255)),Math.round(Math.min(Math.sqrt(128*u),255)),Math.round(Math.min(Math.sqrt(128*l),255)));const j=m.rect.x+$,D=m.rect.y+$,nt=j+m.width,ot=D+m.height;this._offsets.xUpperLeft=j,this._offsets.yUpperLeft=D,this._offsets.xUpperRight=nt,this._offsets.yUpperRight=D,this._offsets.xBottomLeft=j,this._offsets.yBottomLeft=ot,this._offsets.xBottomRight=nt,this._offsets.yBottomRight=ot,Y.symbologyType===Bt.PIE_CHART?(this._texUpperLeft=M(0,1),this._texUpperRight=M(1,1),this._texBottomLeft=M(0,0),this._texBottomRight=M(1,0)):(this._texUpperLeft=M(j,D),this._texUpperRight=M(nt,D),this._texBottomLeft=M(j,ot),this._texBottomRight=M(nt,ot)),o*=g,a*=g,o*=v,a*=v;const wi=Math.round(64*g);this._bitestAndDistRatio=M(z,wi),this._computedWidth=o,this._computedHeight=a;const bi=ue(),Si=ce();this._applyTransformation(Si,bi)}static fromCIMMarker(t,e,i){const r=e&&e.width||1,s=e&&e.height||1,o=t.size,a=r/s*t.scaleX,l=t.scaleSymbolsProportionally&&t.frameHeight?o/t.frameHeight:1;let h=I(t.color);const u=I(t.outlineColor),c=x(o),_=c*a,f=x(t.offsetX||0),d=x(t.offsetY||0),m=x(t.outlineWidth||0)*l,y=t.alignment||B.SCREEN,p=x(t.referenceSize),[g,v]=J(t.scaleInfo,i);e.sdf||h!==0||(h=-1);let b=t.rotation||0;t.rotateClockwise||(b=-b);let L=0,S=0;const T=t.anchorPoint;T&&(t.isAbsoluteAnchorPoint?o&&(L=T.x/(o*a),S=T.y/o):(L=T.x,S=T.y));const z=new U(t.materialKey,f,d,b,h,_,c,p,u,m,t.colorLocked,t.scaleSymbolsProportionally,!1,y,e,L,S,t.sizeRatio,Ct(t.scaleFactor,1),t.markerPlacement,t.effects,g,v);return z._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/_:1,z._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/c:1,z}static fromPictureMarker(t,e){const i=Math.round(x(t.width)),r=Math.round(x(t.height)),s=qe,o=Math.round(x(t.xoffset||0)),a=Math.round(x(t.yoffset||0)),l=new U(t.materialKey,o,a,t.angle,s,i,r,r,0,0,!1,!1,!1,B.SCREEN,e,0,0,1,1,null,null,O,G);return l._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.width:1,l._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.height:1,l}static fromSimpleMarker(t,e){const i=H(t.color),r=Math.round(x(t.size)),s=r,o=Math.round(x(t.xoffset||0)),a=Math.round(x(t.yoffset||0)),l=t.style,h=t.outline,u=0|(h&&h.color&&H(h.color)),c=0|(h&&h.width&&Math.round(x(h.width))),_=new U(t.materialKey,o,a,t.angle,i,r,s,s,u,c,!1,!1,l==="esriSMSCross"||l==="esriSMSX",B.SCREEN,e,0,0,126/64,1,null,null,O,G);return _.boundsType=l==="esriSMSCircle"?"circle":"square",_._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.size:1,_._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.size:1,_}static fromLineSymbolMarker(t,e){const i=H(t.color),r=6,s=Math.round(x(r*t.lineWidth)),o=s,a=t.style==="cross"||t.style==="x";let l;switch(t.placement){case"begin-end":l=bt.Both;break;case"begin":l=bt.JustBegin;break;case"end":l=bt.JustEnd;break;default:l=bt.None}const h={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:l,offsetAlongLine:0},u=new U(t.materialKey,0,0,0,i,s,o,o/r,i,a?Math.round(x(t.lineWidth)):0,!1,!1,a,B.MAP,e,0,0,126/64,1,h,null,O,G);return u.boundsType=t.style==="circle"?"circle":"square",u}};function Br(n,t,e,i,r,s,o){ee=0;const a=(i-e)*s,l=r&&r.length,h=l?(r[0]-e)*s:a;let u,c,_,f,d,m=mi(t,e,i,0,h,s,!0);if(m&&m.next!==m.prev){if(l&&(m=Gr(t,e,i,r,m,s)),a>80*s){u=_=t[0+e*s],c=f=t[1+e*s];for(let y=s;y<h;y+=s){const p=t[y+e*s],g=t[y+1+e*s];u=Math.min(u,p),c=Math.min(c,g),_=Math.max(_,p),f=Math.max(f,g)}d=Math.max(_-u,f-c),d=d!==0?1/d:0}gt(m,n,s,u,c,d,o,0)}}function mi(n,t,e,i,r,s,o){let a;if(o===Ur(n,t,e,i,r,s)>0)for(let l=i;l<r;l+=s)a=Oe(l+t*s,n[l+t*s],n[l+1+t*s],a);else for(let l=r-s;l>=i;l-=s)a=Oe(l+t*s,n[l+t*s],n[l+1+t*s],a);return a&&et(a,a.next)&&(Mt(a),a=a.next),a}function xt(n,t=n){if(!n)return n;let e,i=n;do if(e=!1,i.steiner||!et(i,i.next)&&W(i.prev,i,i.next)!==0)i=i.next;else{if(Mt(i),i=t=i.prev,i===i.next)break;e=!0}while(e||i!==t);return t}function gt(n,t,e,i,r,s,o,a){if(!n)return;!a&&s&&(n=di(n,i,r,s));let l=n;for(;n.prev!==n.next;){const h=n.prev,u=n.next;if(s?Dr(n,i,r,s):Vr(n))t.push(h.index/e+o),t.push(n.index/e+o),t.push(u.index/e+o),Mt(n),n=u.next,l=u.next;else if((n=u)===l){a?a===1?gt(n=Yr(n,t,e,o),t,e,i,r,s,o,2):a===2&&jr(n,t,e,i,r,s,o):gt(xt(n),t,e,i,r,s,o,1);break}}}function Vr(n){const t=n.prev,e=n,i=n.next;if(W(t,e,i)>=0)return!1;let r=n.next.next;const s=r;let o=0;for(;r!==n.prev&&(o===0||r!==s);){if(o++,ut(t.x,t.y,e.x,e.y,i.x,i.y,r.x,r.y)&&W(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function Dr(n,t,e,i){const r=n.prev,s=n,o=n.next;if(W(r,s,o)>=0)return!1;const a=r.x<s.x?r.x<o.x?r.x:o.x:s.x<o.x?s.x:o.x,l=r.y<s.y?r.y<o.y?r.y:o.y:s.y<o.y?s.y:o.y,h=r.x>s.x?r.x>o.x?r.x:o.x:s.x>o.x?s.x:o.x,u=r.y>s.y?r.y>o.y?r.y:o.y:s.y>o.y?s.y:o.y,c=Jt(a,l,t,e,i),_=Jt(h,u,t,e,i);let f=n.prevZ,d=n.nextZ;for(;f&&f.z>=c&&d&&d.z<=_;){if(f!==n.prev&&f!==n.next&&ut(r.x,r.y,s.x,s.y,o.x,o.y,f.x,f.y)&&W(f.prev,f,f.next)>=0||(f=f.prevZ,d!==n.prev&&d!==n.next&&ut(r.x,r.y,s.x,s.y,o.x,o.y,d.x,d.y)&&W(d.prev,d,d.next)>=0))return!1;d=d.nextZ}for(;f&&f.z>=c;){if(f!==n.prev&&f!==n.next&&ut(r.x,r.y,s.x,s.y,o.x,o.y,f.x,f.y)&&W(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;d&&d.z<=_;){if(d!==n.prev&&d!==n.next&&ut(r.x,r.y,s.x,s.y,o.x,o.y,d.x,d.y)&&W(d.prev,d,d.next)>=0)return!1;d=d.nextZ}return!0}function Oe(n,t,e,i){const r=_t.create(n,t,e);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function Mt(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function Or(n){let t=n,e=n;do(t.x<e.x||t.x===e.x&&t.y<e.y)&&(e=t),t=t.next;while(t!==n);return e}function Gr(n,t,e,i,r,s){const o=new Array;for(let a=0,l=i.length;a<l;a++){const h=mi(n,t,e,i[a]*s,a<l-1?i[a+1]*s:e*s,s,!1);h===h.next&&(h.steiner=!0),o.push(Or(h))}o.sort(Hr);for(const a of o)r=Zr(a,r);return r}function Zr(n,t){const e=Kr(n,t);if(!e)return t;const i=yi(e,n);return xt(i,i.next),xt(e,e.next)}function Kr(n,t){let e=t;const i=n.x,r=n.y;let s,o=-1/0;do{if(r<=e.y&&r>=e.next.y&&e.next.y!==e.y){const _=e.x+(r-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(_<=i&&_>o){if(o=_,_===i){if(r===e.y)return e;if(r===e.next.y)return e.next}s=e.x<e.next.x?e:e.next}}e=e.next}while(e!==t);if(!s)return null;if(i===o)return s.prev;const a=s,l=s.x,h=s.y;let u,c=1/0;for(e=s.next;e!==a;)i>=e.x&&e.x>=l&&i!==e.x&&ut(r<h?i:o,r,l,h,r<h?o:i,r,e.x,e.y)&&(u=Math.abs(r-e.y)/(i-e.x),(u<c||u===c&&e.x>s.x)&&vt(e,n)&&(s=e,c=u)),e=e.next;return s}function di(n,t,e,i){for(let r;r!==n;r=r.next){if(r=r||n,r.z===null&&(r.z=Jt(r.x,r.y,t,e,i)),r.prev.next!==r||r.next.prev!==r)return r.prev.next=r,r.next.prev=r,di(n,t,e,i);r.prevZ=r.prev,r.nextZ=r.next}return n.prevZ.nextZ=null,n.prevZ=null,Nr(n)}function Nr(n){let t,e=1;for(;;){let i,r=n;n=null,t=null;let s=0;for(;r;){s++,i=r;let o=0;for(;o<e&&i;o++)i=i.nextZ;let a=e;for(;o>0||a>0&&i;){let l;o===0?(l=i,i=i.nextZ,a--):a!==0&&i?r.z<=i.z?(l=r,r=r.nextZ,o--):(l=i,i=i.nextZ,a--):(l=r,r=r.nextZ,o--),t?t.nextZ=l:n=l,l.prevZ=t,t=l}r=i}if(t.nextZ=null,e*=2,s<2)return n}}function W(n,t,e){return(t.y-n.y)*(e.x-t.x)-(t.x-n.x)*(e.y-t.y)}function pi(n,t,e,i){return!!(et(n,t)&&et(e,i)||et(n,i)&&et(e,t))||W(n,t,e)>0!=W(n,t,i)>0&&W(e,i,n)>0!=W(e,i,t)>0}function Xr(n,t){let e=n;do{if(e.index!==n.index&&e.next.index!==n.index&&e.index!==t.index&&e.next.index!==t.index&&pi(e,e.next,n,t))return!0;e=e.next}while(e!==n);return!1}function Ur(n,t,e,i,r,s){let o=0;for(let a=i,l=r-s;a<r;a+=s)o+=(n[l+t*s]-n[a+t*s])*(n[a+1+t*s]+n[l+1+t*s]),l=a;return o}function ut(n,t,e,i,r,s,o,a){return(r-o)*(t-a)-(n-o)*(s-a)>=0&&(n-o)*(i-a)-(e-o)*(t-a)>=0&&(e-o)*(s-a)-(r-o)*(i-a)>=0}function vt(n,t){return W(n.prev,n,n.next)<0?W(n,t,n.next)>=0&&W(n,n.prev,t)>=0:W(n,t,n.prev)<0||W(n,n.next,t)<0}function Jt(n,t,e,i,r){return(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=32767*(n-e)*r)|n<<8))|n<<4))|n<<2))|n<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function et(n,t){return n.x===t.x&&n.y===t.y}function Hr(n,t){return n.x-t.x}function Yr(n,t,e,i){let r=n;do{const s=r.prev,o=r.next.next;!et(s,o)&&pi(s,r,r.next,o)&&vt(s,o)&&vt(o,s)&&(t.push(s.index/e+i),t.push(r.index/e+i),t.push(o.index/e+i),Mt(r),Mt(r.next),r=n=o),r=r.next}while(r!==n);return r}function jr(n,t,e,i,r,s,o){let a=n;do{let l=a.next.next;for(;l!==a.prev;){if(a.index!==l.index&&qr(a,l)){let h=yi(a,l);return a=xt(a,a.next),h=xt(h,h.next),gt(a,t,e,i,r,s,o,0),void gt(h,t,e,i,r,s,o,0)}l=l.next}a=a.next}while(a!==n)}function qr(n,t){return n.next.index!==t.index&&n.prev.index!==t.index&&!Xr(n,t)&&vt(n,t)&&vt(t,n)&&Qr(n,t)}function Qr(n,t){let e=n,i=!1;const r=(n.x+t.x)/2,s=(n.y+t.y)/2;do e.y>s!=e.next.y>s&&e.next.y!==e.y&&r<(e.next.x-e.x)*(s-e.y)/(e.next.y-e.y)+e.x&&(i=!i),e=e.next;while(e!==n);return i}function yi(n,t){const e=_t.create(n.index,n.x,n.y),i=_t.create(t.index,t.x,t.y),r=n.next,s=t.prev;return n.next=t,t.prev=n,e.next=r,r.prev=e,i.next=e,e.prev=i,s.next=i,i.prev=s,i}class _t{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,i){const r=ee<te.length?te[ee++]:new _t;return r.index=t,r.x=e,r.y=i,r.prev=null,r.next=null,r.z=null,r.prevZ=null,r.nextZ=null,r.steiner=!1,r}}const te=new Array,Jr=8096;let ee=0;for(let n=0;n<Jr;n++)te.push(new _t);const ts=1e-5,tt=new ti(0,0,0,1,0),ie=new ti(0,0,0,1,0);function Ge(n,t,e){let i=0;for(let r=1;r<e;r++){const s=n[2*(t+r-1)],o=n[2*(t+r-1)+1];i+=(n[2*(t+r)]-s)*(n[2*(t+r)+1]+o)}return i}function es(n,t,e,i,r){let s=0;const o=2;for(let a=e;a<i;a+=3){const l=(n[a]-r)*o,h=(n[a+1]-r)*o,u=(n[a+2]-r)*o;s+=Math.abs((t[l]-t[u])*(t[h+1]-t[l+1])-(t[l]-t[h])*(t[u+1]-t[l+1]))}return s}function is(n,t){const{coords:e,lengths:i,hasIndeterminateRingOrder:r}=t,s=0,o=n;if(r)return!1;let a=0;for(let l=0;l<i.length;){let h=l,u=i[l],c=Ge(e,a,u);const _=[];for(;++h<i.length;){const y=i[h],p=Ge(e,a+u,y);if(!(p>0))break;c+=p,_.push(a+u),u+=y}const f=o.length;Br(o,e,a,a+u,_,2,s);const d=es(o,e,f,o.length,s),m=Math.abs(c);if(Math.abs((d-m)/Math.max(1e-7,m))>ts)return o.length=0,!1;l=h,a+=u}return!0}function rs(n){const{coords:t,lengths:e}=n,{buffer:i}=Zi(t,e);return i}function ss(n,t,e){let i=0;for(let r=0;r<n.lengths.length;r++){const s=n.lengths[r];for(let o=0;o<s;o++){const a=n.coords[2*(o+i)],l=n.coords[2*(o+i)+1];if(a<t||a>e||l<t||l>e)return!0}i+=s}return!1}function ns(n,t){if(V(n))return null;if(!ss(n,-128,rt+128))return n;tt.setPixelMargin(t),tt.reset(ni.Polygon);let e=0;for(let o=0;o<n.lengths.length;o++){const a=n.lengths[o];let l=n.coords[2*(0+e)],h=n.coords[2*(0+e)+1];tt.moveTo(l,h);for(let u=1;u<a;u++)l=n.coords[2*(u+e)],h=n.coords[2*(u+e)+1],tt.lineTo(l,h);tt.close(),e+=a}const i=tt.result(!1);if(!i)return null;const r=[],s=[];for(const o of i){let a=0;for(const l of o)s.push(l.x),s.push(l.y),a++;r.push(a)}return new lr(r,s)}function os(n,t){ie.setPixelMargin(t);const e=ie,i=-t,r=rt+t;let s=[],o=!1,a=0;for(;a<n.length;){const l=[],h=n[a];if(!h)return null;e.reset(ni.LineString);let[u,c]=h[0];if(o)e.moveTo(u,c);else{if(u<i||u>r||c<i||c>r){o=!0;continue}l.push({x:u,y:c})}let _=!1;const f=h.length;for(let d=1;d<f;++d)if(u+=h[d][0],c+=h[d][1],o)e.lineTo(u,c);else{if(u<i||u>r||c<i||c>r){_=!0;break}l.push({x:u,y:c})}if(_)o=!0;else{if(o){const d=e.resultWithStarts();if(d)for(const m of d)s.push(m)}else s.push({line:l,start:0});a++,o=!1}}return s=s.filter(l=>l.line.length>1),s.length===0?null:s}tt.setExtent(rt),ie.setExtent(rt);const Rt=8,R=16,Ze=65535,xi=n=>class extends n{constructor(...t){super(...t),this.tessellationProperties={},this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0},this.geometryType=P.LINE}writeGeometry(t,e,i,r){this._writeGeometry(t,e,i,r)}_initializeTessellator(t){const e=Et.load(this._materialKey),i=ft.load(this._materialKey),r=this._tessellationOptions,s=e.vvSizeFieldStops||e.vvSizeMinMaxValue||e.vvSizeScaleStops||e.vvSizeUnitValue,o=this.tessellationProperties._halfWidth<Ei&&!t&&!s;this.tessellationProperties.minMaxZoom=this._minMaxZoom,r.wrapDistance=Ze,r.textured=this._isDashed||this._hasPattern,r.offset=this.tessellationProperties.offset,r.halfWidth=this.tessellationProperties._halfWidth;const a=o?0:1,l=At(i)?ls:as;this._lineTessellator=new Ki(l(this.tessellationProperties,a,a),hs(this.tessellationProperties),o)}_write(t,e,i,r){const s=e.geometryType==="esriGeometryPoint";t.recordStart(e.getDisplayId(),this._materialKey,this.geometryType,s),this._writeGeometry(t,e,r,s),t.recordEnd()}_writeGeometry(t,e,i,r){const s=i??e.readLegacyGeometryForDisplay(),o=this._getLines(s,r);V(o)||this._writeVertices(t,e,o)}_getLines(t,e){if(V(t))return null;const i=t.paths||t.rings;return V(i)?null:os(i,e?256:16)}_writeVertices(t,e,i){const r=e.getDisplayId(),s=t.vertexCount(),o=this.tessellationProperties,a=this._tessellationOptions;o.out=t,o.id=r,o.indexCount=0,o.vertexCount=0,o.offset=s,a.capType=this._capType,a.joinType=this._joinType;const l=ft.load(this._materialKey);this.tessellationProperties.key=At(l)?l:Et.load(this._materialKey);for(const{line:h,start:u}of i)a.initialDistance=u%Ze,this._lineTessellator.tessellate(h,a)}},as=(n,t,e)=>(i,r,s,o,a,l,h,u,c,_,f)=>{const d=M(f,Math.ceil(R*n._halfWidth)),m=F(Math.round(R*h),Math.round(R*u),Math.round(R*c),Math.round(R*_)),y=F(R*a,R*l,0,n._bitset),p=n.out;return p.vertexBounds(i,r,t,e),p.vertexWrite(M(Rt*i,Rt*r)),p.vertexWrite(n.id),p.vertexWrite(n._fillColor),p.vertexWrite(m),p.vertexWrite(d),p.vertexWrite(n._tl),p.vertexWrite(n._br),p.vertexWrite(y),p.vertexWrite(M(Math.ceil(R*n._halfReferenceWidth),0)),p.vertexWrite(n.minMaxZoom),p.vertexEnd(),n.offset+n.vertexCount++},ls=(n,t,e)=>(i,r,s,o,a,l,h,u,c,_,f)=>{const d=M(R*n._halfWidth,R*n._halfReferenceWidth),m=F(R*h+128,R*u+128,R*c+128,R*_+128),y=n.out,p=n._bitset<<24|n.id;y.vertexBounds(i,r,t,e),y.vertexWrite(M(Rt*i,Rt*r)),y.vertexWrite(p),y.vertexWrite(n._fillColor);const g=si(n.key);return g||(y.vertexWrite(0),y.vertexWrite(0)),y.vertexWrite(0),y.vertexWrite(d),y.vertexWrite(m),g||y.vertexWrite(n.minMaxZoom),y.vertexEnd(),n.offset+n.vertexCount++},hs=n=>(t,e,i)=>{const r=n.out;r.indexWrite(t),r.indexWrite(e),r.indexWrite(i),n.indexCount+=3};class X extends xi(wt){constructor(t,e,i,r,s,o,a,l,h,u,c,_,f,d,m,y,p,g,v,b){super();const L=Et.load(t);e&&(L.sdf=e.sdf,L.pattern=!0,L.textureBinding=e.textureBinding),this._capType=r,this._joinType=s,this._miterLimitCosine=jt(o),this.tessellationProperties._fillColor=a,this.tessellationProperties._tl=l,this.tessellationProperties._br=h,this._hasPattern=u,this._isDashed=c,this._zOrder=p,this._effects=g,this._minMaxZoom=M(Math.round(v*C),Math.round(b*C)),this._materialKey=L.data;const S=(f?it:0)|(d?Ai:0)|(_?Qe:0)|(m?kt:0);this.tessellationProperties._bitset=S,this.tessellationProperties._halfWidth=.5*i,this.tessellationProperties._halfReferenceWidth=.5*y,this.tessellationProperties.offset=0,this._initializeTessellator(!1)}static fromCIMLine(t,e,i){const r=t.color,s=t.scaleFactor||1,o=!!t.dashTemplate;let a=t.cap;o&&a===Se.ROUND&&(a=Se.SQUARE);const l=t.join,h=x(t.width)*s,u=x(t.referenceWidth),c=x(t.miterLimit),_=r&&I(r)||0,[f,d]=J(t.scaleInfo,i),m=!1;if(!e)return new X(t.materialKey,e,h,a,l,c,_,0,0,!1,o,t.scaleDash,t.colorLocked,m,t.sampleAlphaOnly,u,t.zOrder,t.effects,f,d);const{rect:y,width:p,height:g}=e,v=y.x+$,b=y.y+$,L=v+p,S=b+g,T=M(v,b),z=M(L,S),K=!1;return new X(t.materialKey,e,h,a,l,c,_,T,z,!0,o,t.scaleDash,t.colorLocked,K,t.sampleAlphaOnly,u,t.zOrder,t.effects,f,d)}static fromFillOutline(t){var i;const e=ft.load(t.materialKey);return At(e)&&t.outline&&((i=t.outline)==null?void 0:i.style)==="esriSLSSolid"?X.fromSimpleLine({hash:"",materialKey:t.materialKey,...t.outline},null,!0):null}static fromSimpleLine(t,e,i=!1){const{color:r}=t,s=t.style!=="esriSLSSolid"&&t.style!=="esriSLSNull",o=ki(t.cap||"round"),a=Bi(t.join||"round");let l=r&&t.style!=="esriSLSNull"&&H(r)||0;t.style==="esriSLSNull"&&(l=0);const h=x(t.width),u=t.miterLimit;if(!e)return new X(t.materialKey,e,h,o,a,u,l,0,0,!1,s,!0,!1,i,!1,h,0,null,O,G);const{rect:c,width:_,height:f}=e,d=c.x+$,m=c.y+$,y=d+_,p=m+f,g=M(d,m),v=M(y,p);return new X(t.materialKey,e,h,o,a,u,l,g,v,!0,s,!0,!1,i,!1,h,0,null,O,G)}static fromPictureLineSymbol(t,e,i,r){return mt.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate").error("PictureLineSymbol support does not exist!"),null}}const cs=100,Ke=1,gi=n=>class extends n{constructor(...t){super(...t),this.forceLibtess=!1,this._bitset=0,this._lineTemplate=null,this.geometryType=P.FILL}_maybeAddLineTemplate(t){this._lineTemplate=X.fromFillOutline(t)}_write(t,e,i,r){const s=e.geometryType==="esriGeometryPoint",o=ft.load(this._materialKey);t.recordStart(e.getDisplayId(),this._materialKey,this.geometryType,s),this._writeGeometry(t,e,o,r,s),At(o)&&E(this._lineTemplate)&&this._lineTemplate.writeGeometry(t,e,r,s),t.recordEnd()}_writeGeometry(t,e,i,r,s){const o=this._getGeometry(e,r,s);if(V(o))return;const a=[];if(!(o.maxLength>cs)&&!this.forceLibtess&&is(a,o))return void(a.length&&this._writeVertices(t,e,o.coords,o.lengths,i,a));const l=rs(o);this._writeVertices(t,e,l,[l.length/2],i)}_writeVertex(t,e,i,r,s,o){const a=M(Ke*r,Ke*s);if(t.vertexBounds(r,s,0,0),t.vertexWrite(a),t.vertexWrite(e),i.symbologyType===Bt.DOT_DENSITY)t.vertexWriteF32(1/Math.abs(o.readGeometryArea()));else{t.vertexWrite(this.fillColor);const l=si(i);l||(t.vertexWrite(this.tl),t.vertexWrite(this.br)),t.vertexWrite(this.aux21),t.vertexWrite(this.aux22),t.vertexWrite(this.aux3),l||t.vertexWrite(this._minMaxZoom)}}_writeVertices(t,e,i,r,s,o){const a=e.getDisplayId(),l=this._bitset<<24|a,h=r.reduce((f,d)=>f+d),u=Ut(s.geometryType,s.symbologyType).geometry/4,c=t.vertexCount();t.vertexEnsureSize(u*h);let _=0;if(o)for(const f of o){const d=i[2*f],m=i[2*f+1];this._writeVertex(t,l,s,d,m,e),_++}else for(let f=0;f<i.length;f+=2){const d=Math.round(i[f]),m=Math.round(i[f+1]);this._writeVertex(t,l,s,d,m,e),_++}t.indexEnsureSize(_);for(let f=0;f<_;f++)t.indexWrite(f+c)}_getGeometry(t,e,i){const r=e?le(he(e),2):t.readGeometryForDisplay();return r?ns(r,i?256:8):null}},Ne=mt.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");let Zt=class extends wt{constructor(t){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=t}analyze(t,e,i,r,s){if(s&&s.length===0)return null;const o=s&&s.length>0,a=e.readLegacyFeature(),l=e.getObjectId(),h=this._materialCache,u=this._cimLayer.materialHash;if(!u)return Ne.error("A Dynamic mesh template must have a material hash value or function!"),Promise.reject(null);const c=typeof u=="function"?u(a,i,r,l):u;if(h.has(c)){const v=h.get(c);return Promise.resolve(v)}const _=this._ongoingMaterialRequestMap.get(c);if(_)return _;const f=this._cimLayer,d=rr(f.cim,this._cimLayer.materialOverrides);d.mosaicHash=c;const{type:m,url:y}=f,p={cim:d,type:m,mosaicHash:c,url:y,size:null,dashTemplate:null,text:null,fontName:null,objectId:l,animatedSymbolProperties:null};switch(m){case"marker":p.size=Pt(f.size,a,i,r),p.animatedSymbolProperties=Pt(f.animatedSymbolProperties,a,i,r);break;case"line":p.dashTemplate=f.dashTemplate;break;case"text":p.text=Pt(f.text,a,i,r),p.fontName=Pt(f.fontName,a,i,r)}const g=t.getMosaicItem(p,s).then(v=>(o||(this._ongoingMaterialRequestMap.delete(c),h.set(c,v)),v)).catch(v=>(this._ongoingMaterialRequestMap.delete(c),Ne.error(".analyze()",v.message),null));return o||this._ongoingMaterialRequestMap.set(c,g),g}};const Xe=128;let Mi=class extends gi(Zt){constructor(t,e,i){var u;if(super(t),this._minMaxZoom=M(Math.round(e*C),Math.round(i*C)),w(t.color)){const c=(_,f,d)=>{const m=t.color(_,f,d);return m&&I(m)||0};this._dynamicPropertyMap.set("fillColor",c)}else{const c=t.color;this.fillColor=c&&I(c)||0}const r=((u=t.cim.placement)==null?void 0:u.type)==="CIMMarkerPlacementInsidePolygon"&&t.cim.placement.shiftOddRows?2:1,s=t.height;if(w(s)){const c=(_,f,d)=>s(_,f,d)*r;this._dynamicPropertyMap.set("_height",c)}else this._height=(s||0)*r;const o=t.offsetX;if(w(o)){const c=(_,f,d)=>x(o(_,f,d));this._dynamicPropertyMap.set("_offsetX",c)}else this._offsetX=x(o||0);const a=t.offsetY;if(w(a)){const c=(_,f,d)=>x(-a(_,f,d));this._dynamicPropertyMap.set("_offsetY",c)}else this._offsetY=x(-a||0);const l=t.scaleX;w(l)?this._dynamicPropertyMap.set("_scaleX",l):this._scaleX=l||1;const h=t.angle;if(w(h)){const c=(_,f,d)=>Yt(h(_,f,d));this._dynamicPropertyMap.set("_angle",c)}else this._angle=Yt(h)||0;if(E(t.effects)){const c=t.effects;w(c)?this._dynamicPropertyMap.set("_effects",c):this._effects=c}this._cimFillLayer=t,this._bitset=(t.colorLocked?it:0)|(t.applyRandomOffset?Je:0)|(t.sampleAlphaOnly?kt:0),this._fillMaterialKey=t.materialKey}static fromCIMFill(t,e){const[i,r]=J(t.scaleInfo,e);return new Mi(t,i,r)}bindFeature(t,e,i){const r=t.readLegacyFeature();this._dynamicPropertyMap.forEach((u,c)=>{this[c]=u(r,e,i)});const s=ft.load(this._fillMaterialKey),o=this._materialCache,a=(0,this._cimFillLayer.materialHash)(r,e,i),l=o.get(a);let h=null;if(l&&k(l.spriteMosaicItem)&&(h=l.spriteMosaicItem),h){const{rect:u,width:c,height:_}=h,f=u.x+$,d=u.y+$,m=f+c,y=d+_;let p=Math.round(x(this._height));p<=0&&(p=y-d);let g=Math.round(x(this._height/_*c||0));g<=0&&(g=m-f);const v=this._scaleX,b=1;this.tl=M(f,d),this.br=M(m,y),this.aux21=M(g,p),this.aux22=M(this._offsetX,this._offsetY),this.aux3=F(v*Xe,b*Xe,this._angle,0),s.sdf=h.sdf,s.pattern=!0,s.textureBinding=h.textureBinding}else this.tl=0,this.br=0,this.aux21=0,this.aux22=0,this.aux3=0,s.sdf=!1,s.pattern=!1,s.textureBinding=0;this._materialKey=s.data}};class pe extends xi(Zt){constructor(t,e,i){super(t),this._minMaxZoom=M(Math.round(e*C),Math.round(i*C)),this._cimLineLayer=t;let r=0;w(t.width)||(r=.5*x(t.width));const s=(c,_,f)=>w(t.width)?.5*x(t.width(c,_,f)):r;this._dynamicPropertyMap.set("_halfWidth",s),w(t.cap)?this._dynamicPropertyMap.set("_capType",t.cap):this._capType=t.cap,w(t.join)?this._dynamicPropertyMap.set("_joinType",t.join):this._joinType=t.join;const o=t.color;if(w(o)){const c=(_,f,d)=>I(o(_,f,d));this._dynamicPropertyMap.set("_fillColor",c)}else this._fillColor=o&&I(o)||0;const a=t.miterLimit;if(w(a)){const c=(_,f,d)=>jt(a(_,f,d));this._dynamicPropertyMap.set("_miterLimitCosine",c)}else this._miterLimitCosine=jt(a);if(E(t.effects)){const c=t.effects;w(c)?this._dynamicPropertyMap.set("_effects",c):this._effects=c}this._scaleFactor=t.scaleFactor||1,this._isDashed=t.dashTemplate!=null;const l=t.colorLocked?it:0,h=t.scaleDash?Qe:0,u=t.sampleAlphaOnly?kt:0;this.tessellationProperties._bitset=l|h|u,this._materialKey=t.materialKey,this._initializeTessellator(!0)}static fromCIMLine(t,e){const[i,r]=J(t.scaleInfo,e);return new pe(t,i,r)}bindFeature(t,e,i){const r=t.readLegacyFeature();this._dynamicPropertyMap.forEach((u,c)=>{this[c]=u(r,e,i)}),this._halfWidth*=this._scaleFactor;const s=this._materialCache,o=(0,this._cimLineLayer.materialHash)(r,e,i),a=s.get(o);let l=null;if(a&&k(a.spriteMosaicItem)&&(l=a.spriteMosaicItem),l){this._hasPattern=!0;const{rect:u,width:c,height:_}=l,f=u.x+$,d=u.y+$,m=f+c,y=d+_;this.tessellationProperties._tl=M(f,d),this.tessellationProperties._br=M(m,y)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties.offset=0,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const h=Et.load(this._materialKey);l&&(h.sdf=l.sdf,h.pattern=!0,h.textureBinding=l.textureBinding),this._materialKey=h.data}}const us=ue(),fs=ce();class ye extends _i(Zt){constructor(t,e,i){super(t),this._cimMarkerLayer=t,this._minMaxZoom=M(Math.round(e*C),Math.round(i*C));const r=t.color;if(w(r)){const _=(f,d,m)=>I(r(f,d,m));this._dynamicPropertyMap.set("_fillColor",_)}else this._fillColor=I(r);const s=t.outlineColor;if(w(s)){const _=(f,d,m)=>I(s(f,d,m));this._dynamicPropertyMap.set("_outlineColor",_)}else this._outlineColor=I(s);const o=t.size;if(w(o)){const _=(f,d,m)=>x(o(f,d,m));this._dynamicPropertyMap.set("_size",_)}else this._size=x(o)||0;const a=t.scaleX;w(a)?this._dynamicPropertyMap.set("_scaleX",a):this._scaleX=a;const l=t.offsetX;if(w(l)){const _=(f,d,m)=>x(l(f,d,m));this._dynamicPropertyMap.set("xOffset",_)}else this.xOffset=x(l)||0;const h=t.offsetY;if(w(h)){const _=(f,d,m)=>x(h(f,d,m));this._dynamicPropertyMap.set("yOffset",_)}else this.yOffset=x(h)||0;const u=t.outlineWidth;if(w(u)){const _=(f,d,m)=>x(u(f,d,m));this._dynamicPropertyMap.set("_outlineWidth",_)}else this._outlineWidth=x(u)||0;const c=t.rotation;if(w(c)?this._dynamicPropertyMap.set("_angle",c):this._angle=c||0,E(t.effects)){const _=t.effects;w(_)?this._dynamicPropertyMap.set("_effects",_):this._effects=_}if(E(t.markerPlacement)){const _=t.markerPlacement;w(_)?this._dynamicPropertyMap.set("_markerPlacement",_):this._markerPlacement=_}this._scaleFactor=Ct(t.scaleFactor,1),this._bitSet=(t.alignment===B.MAP?1:0)|(t.colorLocked?1:0)<<1|(t.scaleSymbolsProportionally?1:0)<<3,this._materialKey=t.materialKey}static fromCIMMarker(t,e){const[i,r]=J(t.scaleInfo,e);return new ye(t,i,r)}bindFeature(t,e,i){const r=t.readLegacyFeature(),s=t.getObjectId();this._dynamicPropertyMap.forEach((nt,ot)=>{this[ot]=nt(r,e,i)});const o=this._cimMarkerLayer.materialHash,a=typeof o=="function"?o(r,e,i,s):o,l=this._materialCache.get(a);if(!l||!k(l.spriteMosaicItem)||!l.spriteMosaicItem)return void mt.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate").error(new st("mapview-cim","Encountered an error when binding feature"));const h=l.spriteMosaicItem,u=this._cimMarkerLayer.sizeRatio,c=h.width/h.height*this._scaleX,_=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let f=this._size,d=f*c;const m=this.xOffset,y=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const p=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/x(this._cimMarkerLayer.frameHeight):1,g=this._outlineWidth*p,v=x(this._cimMarkerLayer.referenceSize);let b=0,L=0;const S=this._cimMarkerLayer.anchorPoint;S&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(b=x(S.x)/(this._size*c),L=x(S.y)/this._size):(b=S.x,L=S.y)),this._anchorX=b,this._anchorY=L,this._sizeOutlineWidth=F(Math.round(Math.min(Math.sqrt(128*d),255)),Math.round(Math.min(Math.sqrt(128*f),255)),Math.round(Math.min(Math.sqrt(128*g),255)),Math.round(Math.min(Math.sqrt(128*v),255))),this.angle=_;const T=Math.round(64*u);this._bitestAndDistRatio=M(this._bitSet,T);const z=h.rect.x+$,K=h.rect.y+$,Y=z+h.width,j=K+h.height;this._texUpperLeft=M(z,K),this._texUpperRight=M(Y,K),this._texBottomLeft=M(z,j),this._texBottomRight=M(Y,j);const D=oe.load(this._materialKey);D.sdf=h.sdf,D.pattern=!0,D.textureBinding=h.textureBinding,this._materialKey=D.data,d*=u,f*=u,d*=this._scaleFactor,f*=this._scaleFactor,d*=h.rect.width/h.width,f*=h.rect.height/h.height,this._computedWidth=d,this._computedHeight=f,this._applyTransformation(fs,us),this.xOffset=m,this.yOffset=y}}function vi(n){const t=new Array(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e);return t}const Ue=5;function _s(n,t,e,i){return typeof n.text=="string"?n.text:typeof n.text=="function"?n.text(t,e,i):""}class xe extends fi(Zt){constructor(t,e,i){super(t),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map,this._minMaxZoom=M(Math.round(e*C),Math.round(i*C));const r=t.scaleFactor||1;this._cimTextLayer=t;const s=t.color;if(w(s)){const m=(y,p,g)=>I(s(y,p,g));this._dynamicPropertyMap.set("_color",m)}else this._color=I(s);const o=t.outlineColor;if(w(o)){const m=(y,p,g)=>I(o(y,p,g));this._dynamicPropertyMap.set("_haloColor",m)}else this._haloColor=I(o);let a;w(t.size)||(a=Math.min(Math.round(x(t.size*t.sizeRatio)),127));const l=(m,y,p)=>w(t.size)?Math.min(Math.round(x(t.size(m,y,p)*t.sizeRatio)),127):a;if(this._dynamicPropertyMap.set("_size",l),w(t.outlineSize)){const m=(y,p,g)=>Math.min(Math.floor(Ue*x(t.outlineSize(y,p,g)*t.sizeRatio)),127);this._dynamicPropertyMap.set("_haloSize",m)}else this._haloSize=Math.min(Math.floor(Ue*x(t.outlineSize*t.sizeRatio)),127);let h;w(t.offsetX)||(h=Math.round(x(t.offsetX*t.sizeRatio)));const u=(m,y,p)=>w(t.offsetX)?Math.round(x(t.offsetX(m,y,p)*t.sizeRatio)):h;let c;this._dynamicPropertyMap.set("_xOffset",u),w(t.offsetY)||(c=Math.round(x(t.offsetY*t.sizeRatio)));const _=(m,y,p)=>w(t.offsetY)?Math.round(x(t.offsetY(m,y,p)*t.sizeRatio)):c;if(this._dynamicPropertyMap.set("_yOffset",_),w(t.angle)?this._dynamicPropertyMap.set("_angle",t.angle):this._angle=t.angle,w(t.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",t.horizontalAlignment):this._horizontalAlignment=t.horizontalAlignment,w(t.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",t.verticalAlignment):this._verticalAlignment=t.verticalAlignment,E(t.effects)){const m=t.effects;w(m)?this._dynamicPropertyMap.set("_effects",m):this._effects=m}if(E(t.markerPlacement)){const m=t.markerPlacement;w(m)?this._dynamicPropertyMap.set("_markerPlacement",m):this._textPlacement=m}w(t.text)?this._dynamicPropertyMap.set("_text",t.text):this._text=t.text,this._scaleFactor=r;const f=Math.min(Math.round(x(t.referenceSize*t.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*f)),this._materialKey=t.materialKey;const d=Ji.load(this._materialKey);d.sdf=!0,this._bitset=(t.alignment===B.MAP?1:0)|(t.colorLocked?1:0)<<1,this._materialKey=d.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._isCIM=!0}static fromCIMText(t,e){const[i,r]=J(t.scaleInfo,e);return new xe(t,i,r)}async analyze(t,e,i,r){const s=e.readLegacyFeature(),o=_s(this._cimTextLayer,s,i,r),a=await super.analyze(t,e,i,r,vi(o));return a&&a.glyphMosaicItems&&this._textToGlyphs.set(o,a.glyphMosaicItems),a}bindFeature(t,e,i){const r=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach((o,a)=>{this[a]=o(r,e,i)}),!this._text||this._text.length===0)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/je,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=ii(Ct(this._horizontalAlignment,"center")),this._yAlignD=ri(Ct(this._verticalAlignment,"baseline"));const s=this._textToGlyphs.get(this._text);this.bindTextInfo(s,!1)}}const ht=128;let q=class extends gi(wt){constructor(t,e,i,r,s,o,a,l,h,u,c,_,f,d,m,y){super(),this._effects=d;const p=ft.load(t);e&&(p.sdf=e.sdf,p.pattern=!0,p.textureBinding=e.textureBinding),this.fillColor=i,this.tl=r,this.br=s,this.aux21=M(o,a),this.aux22=M(l,h),this.aux3=F(u,c,_,0),this._bitset=f,this._minMaxZoom=M(Math.round(m*C),Math.round(y*C)),this._materialKey=p.data}static fromCIMFill(t,e,i){const r=t.color,s=r&&I(r)||0,o=t.materialKey,[a,l]=J(t.scaleInfo,i),h=(t.colorLocked?it:0)|(t.applyRandomOffset?Je:0)|(t.sampleAlphaOnly?kt:0);if(!e)return new q(o,null,s,0,0,0,0,0,0,0,0,0,h,t.effects,a,l);const{rect:u,width:c,height:_}=e,f=t.scaleX||1,d=u.x+$,m=u.y+$,y=d+c,p=m+_,g=x(t.height),v=f*g;let b=Math.round(g);b<=0&&(b=p-m);let L=Math.round(v);L<=0&&(L=y-d);const S=x(t.offsetX||0),T=x(-t.offsetY||0),z=M(d,m),K=M(y,p);return new q(o,e,s,z,K,L,b,S,T,ht,ht,Yt(t.angle),h,t.effects,a,l)}static fromSimpleFill(t,e,i=!1){const{color:r}=t,s=r&&t.style!=="esriSFSNull"&&H(r)||0,o=i?it:0,a=t.materialKey;let l;if(e){const{rect:h,width:u,height:c,pixelRatio:_}=e,f=h.x+$,d=h.y+$,m=f+u,y=d+c,p=M(f,d),g=M(m,y);l=new q(a,e,s,p,g,u/_,c/_,0,0,ht,ht,0,o,null,O,G)}else l=new q(a,null,s,0,0,0,0,0,0,0,0,0,o,null,O,G);return l._maybeAddLineTemplate(t),l}static fromPictureFill(t,e,i=!1){const r=qe,{rect:s,width:o,height:a}=e,l=s.x+$,h=s.y+$,u=l+o,c=h+a,_=M(l,h),f=M(u,c),d=Math.round(x(t.width)),m=Math.round(x(t.height)),y=x(t.xoffset),p=x(-t.yoffset),g=t.materialKey,v=i?it:0,b=new q(g,e,r,_,f,d,m,y,p,ht*t.xscale,ht*t.yscale,0,v,null,O,G);return b._maybeAddLineTemplate(t),b}};class ms{constructor(){this._resolver=null}isHeld(){return!!this._resolver}async acquire(){this._resolver?(await this._resolver.promise,await this.acquire()):this._resolver=Oi()}release(){const t=this._resolver;this._resolver=null,t==null||t.resolve()}}async function ds(n,t,e){try{await n.acquire(),await t(e),n.release()}catch(i){throw n.release(),i}}async function ps(n,t,e){if(!n.name)throw new st("style-symbol-reference-name-missing","Missing name in style symbol reference");if(n.styleName&&n.styleName==="Esri2DPointSymbolsStyle")return ys(n,e);try{return xs(await xr(n,t,e),n.name,t,e)}catch(i){return ne(i),null}}async function ys(n,t){const e=gr.replace(/\{SymbolName\}/gi,n.name);try{const i=await ai(e,t);return li(i.data)}catch(i){return ne(i),null}}async function xs(n,t,e,i){const r=n.data,s={portal:e&&E(e.portal)?e.portal:pr.getDefault(),url:dr(n.baseUrl),origin:"portal-item"},o=r.items.find(l=>l.name===t);if(!o)throw new st("symbolstyleutils:symbol-name-not-found",`The symbol name '${t}' could not be found`,{symbolName:t});let a=yr(Mr(o,"cimRef"),s);_r()&&(a=mr(a));try{const l=await ai(a,i);return li(l.data)}catch(l){return ne(l),null}}const He=async(n,t,e)=>new fr(await sr(n.data,t,e),n.data,n.rendererKey,n.maxVVSize),Z=async(n,t,e,i)=>{if(!n)return null;if(n.type==="cim")return He(n,t,e);if(n.type==="web-style"){const r={type:"cim",data:await ps(n,null,i),rendererKey:n.rendererKey,maxVVSize:n.maxVVSize};return He(r,t,e)}return n};function Wt(n){if(!n)return null;const{type:t,cim:e,url:i,materialHash:r}=n,s={cim:e,type:t,mosaicHash:r,url:i,size:null,dashTemplate:null,path:null,text:null,fontName:null,animatedSymbolProperties:null};switch(t){case"marker":s.size=n.size,s.path=n.path,s.animatedSymbolProperties=n.animatedSymbolProperties;break;case"line":s.dashTemplate=n.dashTemplate;break;case"text":s.text=n.text,s.fontName=n.fontName}return s}const A=mt.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),Ye=new Array,ge={isOutline:!1,placement:null,symbologyType:Bt.DEFAULT,vvFlags:0},gs={...Pe,hash:JSON.stringify(Pe),materialKey:ae(P.MARKER,ge)},Ms={...Te,hash:JSON.stringify(Te),materialKey:ae(P.LINE,ge)},vs={...ze,hash:JSON.stringify(ze),materialKey:ae(P.FILL,ge)};function N(n,t){const e=n.length;return n.push(null),t.then(i=>n[e]=i),n}function pt(n){return!!(1&n)}function ws(n){return n.name==="worker:port-closed"}class Tn{constructor(t,e){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new ms,this._fetchResource=t,this._tileInfo=e}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(t,e){this._initErrorTemplates();const i=t.hash;if(this._symbolToTemplate.has(i))return this._symbolToTemplate.get(i);const r=new Array;e&&this._createMeshTemplates(r,e,!0),this._createMeshTemplates(r,t,!1);const s=this._createGroupId(t.type==="expanded-cim"&&bs(t));return this._idToTemplateGroup.set(s,r),this._symbolToTemplate.set(i,s),s}getTemplateGroup(t){return this._idToTemplateGroup.has(t)?this._idToTemplateGroup.get(t):Ye}getDynamicTemplateGroup(t){return this._idToTemplateGroup.has(t)?(pt(t)||A.error("mapview-template-store",`Id ${t} does not refer to a dynamic template`),this._idToTemplateGroup.get(t)):Ye}getMosaicItem(t,e){const i=this._createTemplateId(),r=new Promise(s=>this._idToResolver.set(i,s));return this._fetchQueue.push({symbol:t,id:i,glyphIds:e}),r}finalize(t){return this._fetchQueue.length||this._lock.isHeld()?ds(this._lock,this._fetchAllQueuedResources.bind(this),t):Promise.resolve()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],vs,!1),marker:this._createMeshTemplates([],gs,!1),line:this._createMeshTemplates([],Ms,!1)})}_fetchAllQueuedResources(t){if(!this._fetchQueue.length)return Promise.resolve();const e=this._fetchQueue,i=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(i).then(()=>this._fetchResource(e,t).then(r=>{for(const{id:s,mosaicItem:o}of r)this._idToResolver.get(s)(o),this._idToResolver.delete(s)})).catch(r=>{Gi(r)?this._fetchQueue=this._fetchQueue.concat(e):ws(r)||A.error(new st("mapview-template-store","Unable to fetch requested texture resources",r))})}_createGroupId(t){return this._idCounter++<<1|(t?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return k(e,A)?U.fromSimpleMarker(t,e):this._markerError}async _createPMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return k(e,A)?U.fromPictureMarker(t,e):this._markerError}async _createSFS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return k(i,A)?q.fromSimpleFill(t,i,e):this._fillError}async _createPFS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return k(i,A)?q.fromPictureFill(t,i,e):this._fillError}async _createSLS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return k(i,A)?X.fromSimpleLine(t,i):this._lineError}async _createLMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return k(e,A)?U.fromLineSymbolMarker(t,e):this._markerError}async _createTS(t){const{glyphMosaicItems:e}=await this.getMosaicItem(t);return yt.fromText(t,e)}async _createCIMText(t){const{glyphMosaicItems:e}=await this.getMosaicItem(Wt(t),vi(t.text));return k(e,A)?yt.fromCIMText(t,e,this._tileInfo):this._textError}async _createCIMFill(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Wt(t));return k(e,A)?q.fromCIMFill(t,e,this._tileInfo):this._fillError}async _createCIMLine(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Wt(t));return k(e,A)?X.fromCIMLine(t,e,this._tileInfo):this._lineError}async _createCIMMarker(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Wt(t));return k(e,A)?U.fromCIMMarker(t,e,this._tileInfo):this._markerError}async _createCIM(t){const e=t.templateHash;if(this._cimTemplateCache.has(e))return this._cimTemplateCache.get(e);let i;switch(t.type){case"marker":i=await this._createCIMMarker(t);break;case"line":i=await this._createCIMLine(t);break;case"fill":i=await this._createCIMFill(t);break;case"text":i=await this._createCIMText(t)}return this._cimTemplateCache.set(e,i),i}async _createDynamicCIM(t){const e=t.templateHash;if(this._cimTemplateCache.has(e))return this._cimTemplateCache.get(e);let i;switch(t.type){case"marker":i=ye.fromCIMMarker(t,this._tileInfo);break;case"line":i=pe.fromCIMLine(t,this._tileInfo);break;case"fill":i=Mi.fromCIMFill(t,this._tileInfo);break;case"text":i=xe.fromCIMText(t,this._tileInfo)}return this._cimTemplateCache.set(e,i),i}_createPrimitiveMeshTemplates(t,e,i){switch(e.type){case"esriSMS":return N(t,this._createSMS(e));case"esriPMS":return N(t,this._createPMS(e));case"esriSFS":return N(t,this._createSFS(e,i));case"line-marker":return N(t,this._createLMS(e));case"esriPFS":return N(t,this._createPFS(e,i));case"esriSLS":return N(t,this._createSLS(e,!1));case"esriTS":return N(t,this._createTS(e));default:return A.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),t}}_createMeshTemplates(t,e,i){if(e.type.includes("3d"))return A.error("3D symbols are not supported with MapView"),t;if(e.type==="expanded-cim"){for(const r of e.layers)typeof r.materialHash=="function"?N(t,this._createDynamicCIM(r)):N(t,this._createCIM(r));return t}if(e.type==="composite-symbol"){for(const r of e.layers)this._createPrimitiveMeshTemplates(t,r,i);return t}return e.type==="cim"||e.type==="label"||e.type==="web-style"?t:this._createPrimitiveMeshTemplates(t,e,i)}}const bs=n=>{if(!n.layers)return!1;for(const t of n.layers)if(typeof t.materialHash=="function")return!0;return!1};let zn=class{constructor(t,e,i){this._loadPromise=Ni(),this._geometryType=t,this._idField=e,this._templateStore=i}update(t,e){E(t.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(t.mesh.labels,e)),this._schema=t}_createLabelTemplates(t,e){const i=new Map;if(t.type==="simple"){for(const r of t.classes){const s=Qt.fromLabelClass(r,e);i.set(r.index,s)}return i}for(const r in t.classes){const s=t.classes[r];for(const o of s){const a=Qt.fromLabelClass(o,e);i.set(o.index,a)}}return i}get templates(){return this._templateStore}async analyze(t,e,i,r,s,o,a){if(be(a))return;let l;i.type==="dictionary"&&(l=await i.analyze(this._idField,t.copy(),e,s,o,a));let h=0;for(;t.next();){let u;if(u=l?l[h++]:E(r)&&Fi(t.getDisplayId())&&t.readAttribute("cluster_count")!==1?r.match(this._idField,t,this._geometryType,s,o):i.match(this._idField,t,this._geometryType,s,o),t.setGroupId(u),pt(u)){const c=this._templateStore.getDynamicTemplateGroup(u);for(const _ of c)_&&_.analyze&&_.analyze(this._templateStore,t,s,o)}}return await this._loadPromise,this._templateStore.finalize(a)}async analyzeGraphics(t,e,i,r,s,o){if(be(o))return;const a=t.getCursor();for(i&&await i.analyze(this._idField,a.copy(),e,r,s,o);a.next();){let l=a.getGroupId();if(l!=null&&l!==-1||(l=i.match(this._idField,a,a.geometryType,r,s),a.setGroupId(l)),pt(l)){const h=this._templateStore.getDynamicTemplateGroup(l);for(const u of h)u&&u.analyze&&u.analyze(this._templateStore,a,r,s)}a.setGroupId(l)}return await this._loadPromise,this._templateStore.finalize(o)}writeGraphic(t,e,i,r){const s=e.getGroupId(),o=e.getDisplayId(),a=this._templateStore.getTemplateGroup(s);if(t.featureStart(e.insertAfter,0),o!=null){if(pt(s))for(const l of a)l&&l.bindFeature(e,null,null);if(a){for(const l of a)l&&l.write(t,e,i,r);t.featureEnd()}}}writeCursor(t,e,i,r,s,o,a){const l=e.getGroupId(),h=e.getDisplayId(),u=this._templateStore.getTemplateGroup(l),c=this._schema.mesh.sortKey;let _=0;if(E(c)&&(_=c.fieldIndex!=null?e.getComputedNumericAtIndex(c.fieldIndex):c.field!=null?e.readAttribute(c.field):e.readAttribute(this._idField),_*=c.order==="asc"?1:-1),t.featureStart(0,_==null||isNaN(_)?0:_),h!=null&&u){if(pt(l))for(const f of u)f.bindFeature(e,i,r);for(const f of u)f.write(t,e,s,a);if(E(o)&&t.hasRecords){const f=o&&this._findLabelRef(u);this._writeLabels(t,e,o,f,s,a)}t.featureEnd()}}_findLabelRef(t){for(const e of t)if(e instanceof U)return e;return null}_writeLabels(t,e,i,r,s,o){for(const a of i)if(E(a)&&a){const{glyphs:l,rtl:h,index:u}=a,c=this._labelTemplates.get(u);c.setZoomLevel(s),c.bindReferenceTemplate(r),c.bindTextInfo(l,h),c.write(t,e,null,o)}}};const re=mt.getLogger("esri/views/2d/engine/webgl/util/Matcher");async function Ss(n,t,e,i){switch(n.type){case"simple":case"heatmap":return Q.fromBasicRenderer(n,t,e,i);case"map":return ve.fromUVRenderer(n,t,e,i);case"interval":return Me.fromCBRenderer(n,t,e,i);case"dictionary":return we.fromDictionaryRenderer(n,t,e,i);case"pie-chart":return Ft.fromPieChartRenderer(n,t,e,i);case"subtype":return Ft.fromSubtypes(n,t,e,i)}}class Q{constructor(){this.type="feature",this._defaultResult=null}static async fromBasicRenderer(t,e,i,r){const s=new Q;if(t.symbol){const o=await Z(t.symbol,i,r),a=e.createTemplateGroup(o,null);s.setDefault(a)}return s}static async fromPieChartRenderer(t,e,i,r){const s=new Q;if(t.markerSymbol){const o=await Z(t.markerSymbol,i,r);let a;t.fillSymbol&&(a=await Z(t.fillSymbol,i,r));const l=e.createTemplateGroup(o,a);s.setDefault(l)}return s}size(){return 1}getDefault(){return this._defaultResult}setDefault(t){this._defaultResult=t}match(t,e,i,r,s){return this.getDefault()}async analyze(t,e,i,r,s,o){return null}}class Ft extends Q{constructor(t,e){super(),this._subMatchers=t,this._subtypeField=e}static async fromSubtypes(t,e,i,r){const s=new Map,o=[];for(const a in t.renderers){const l=parseInt(a,10),h=Ss(t.renderers[a],e,i,r).then(u=>s.set(l,u));o.push(h)}return await Promise.all(o),new Ft(s,t.subtypeField)}match(t,e,i,r,s){const o=e.readAttribute(this._subtypeField),a=this._subMatchers.get(o);return a?a.match(t,e,i,r,s):null}}class Me extends Q{constructor(t,e,i,r){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=e,this._fieldIndex=r,this._field=t,this._normalizationInfo=i}static async fromCBRenderer(t,e,i,r){const{isMaxInclusive:s,normalizationField:o,normalizationTotal:a,normalizationType:l}=t,h=t.field,u=new Me(h,s,{normalizationField:o,normalizationTotal:a,normalizationType:l},t.fieldIndex),c=await Z(t.backgroundFillSymbol,i,r);await Promise.all(t.intervals.map(async f=>{const d=await Z(f.symbol,i,r),m=await e.createTemplateGroup(d,c),y={min:f.min,max:f.max};u.add(y,m)}));const _=await Z(t.defaultSymbol,i,r);if(_){const f=await e.createTemplateGroup(_,c);u.setDefault(f)}return u}add(t,e){this._intervals.push({interval:t,result:e}),this._intervals.sort((i,r)=>i.interval.min-r.interval.min)}size(){return super.size()+this._intervals.length}match(t,e,i,r,s){if(this._fieldIndex==null&&!this._field)return this.getDefault();const o=this._fieldIndex!=null?e.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(e);if(o==null||isNaN(o)||o===1/0||o===-1/0)return this.getDefault();for(let a=0;a<this._intervals.length;a++){const{interval:l,result:h}=this._intervals[a],u=o>=l.min,c=this._isMaxInclusive?o<=l.max:o<l.max;if(u&&c)return h}return this.getDefault()}_needsNormalization(){const t=this._normalizationInfo;return t&&(t.normalizationField||t.normalizationTotal||t.normalizationType)}_getValueFromField(t){const e=t.readAttribute(this._field);if(!this._needsNormalization()||e==null)return e;const{normalizationField:i,normalizationTotal:r,normalizationType:s}=this._normalizationInfo,o=!!i&&t.readAttribute(i);if(s)switch(s){case"esriNormalizeByField":return o?e/o:void 0;case"esriNormalizeByLog":return Math.log(e)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return e/r*100;default:return void re.error(`Found unknown normalization type: ${s}`)}else re.error("Normalization is required, but no type was set!")}}class ve extends Q{constructor(t,e,i){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fieldsIndex=i,this._fields=t,this._seperator=e||""}static async fromUVRenderer(t,e,i,r){const s=t.fieldDelimiter,o=[t.field];t.field2&&o.push(t.field2),t.field3&&o.push(t.field3);const a=await Z(t.backgroundFillSymbol,i,r),l=new ve(o,s,t.fieldIndex);await Promise.all(t.map.map(async u=>{const c=await Z(u.symbol,i,r),_=await e.createTemplateGroup(c,a);u.value==="<Null>"?l.setNullResult(_):l.add(u.value,_)}));const h=await Z(t.defaultSymbol,i,r);if(h){const u=await e.createTemplateGroup(h,a);l.setDefault(u)}return l}setNullResult(t){this._nullResult=t}add(t,e){this._resultsMap.set(t.toString(),e)}size(){return super.size()+this._resultsMap.size}match(t,e,i,r,s){if(this._fieldsIndex==null&&!this._fields)return this.getDefault();const o=this._fieldsIndex!=null?e.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(e);if(this._nullResult!==null&&(o==null||o===""||o==="<Null>"))return this._nullResult;if(o==null)return this.getDefault();const a=o.toString();return this._resultsMap.has(a)?this._resultsMap.get(a):this.getDefault()}_getValueFromFields(t){const e=[];for(const i of this._fields){const r=t.readAttribute(i);r==null||r===""?e.push("<Null>"):e.push(r)}return e.join(this._seperator)}}async function Ls(n,t){const e=n||1;if(typeof e=="number")return(r,s,o)=>e;const i=await cr(e,t.spatialReference,t.fields);return(r,s,o)=>ur(i,r,{$view:o},t.geometryType,s)||1}let Nt;async function Ps(){return Nt||(Nt=oi(()=>import("./createSymbolSchema-1bb8123a.js"),["assets/createSymbolSchema-1bb8123a.js","assets/enums-4ca4641f.js","assets/MaterialKey-a0a08f8b.js","assets/Error-57322e92.js","assets/string-480f3e3f.js","assets/typedArrayUtil-d9bc5fbd.js","assets/alignmentUtils-ae955d28.js"])),Nt}class we extends Q{constructor(t,e,i,r,s,o){super(),this.type="dictionary",this._groupIdCache=new hr(100),this._loader=t,this._fieldMap=t.fieldMap,this._symbolFields=t.getSymbolFields(),this._templates=e,this._info=i,this._scaleFn=r,this._schemaUtilsModule=s,this._symbolOptions=o}static async fromDictionaryRenderer(t,e,i,r){const[{DictionaryLoader:s},o]=await Promise.all([oi(()=>import("./DictionaryLoader-326d0e17.js"),["assets/DictionaryLoader-326d0e17.js","assets/Color-af6e0c66.js","assets/colorUtils-639f4d25.js","assets/mathUtils-57aba1ea.js","assets/vec3-1863987c.js","assets/vec3f64-6cd30318.js","assets/common-c186b691.js","assets/vec4-46a9b36d.js","assets/typedArrayUtil-d9bc5fbd.js","assets/ensureType-25b8cc06.js","assets/string-480f3e3f.js","assets/Error-57322e92.js","assets/request-f17a8ddb.js","assets/preload-helper-101896b7.js","assets/promiseUtils-32d9c228.js","assets/LRUCache-b9228ca3.js","assets/MemCache-1d2f56ee.js","assets/cast-a534ae90.js","assets/nextTick-3ee5a785.js","assets/arcadeOnDemand-5175e7d9.js","assets/geometry-eec1b371.js","assets/Extent-a1a1de42.js","assets/Polyline-b571c705.js","assets/typeUtils-cd52dc20.js","assets/jsonMap-190c5593.js","assets/CIMSymbol-8f02a6e3.js","assets/enumeration-61a13175.js","assets/fieldUtils-77ec75e2.js","assets/Symbol-8266348e.js"]),Ps()]),a=new s(t.url,t.config,t.fieldMap);await a.fetchResources({spatialReference:i.spatialReference,fields:i.fields});const l=await Ls(t.scaleExpression,i);return new we(a,e,i,l,o,t.symbolOptions)}async _analyzeFeature(t,e,i,r,s){const o=t.readLegacyFeature(),a=this._scaleFn(o,i,r),l=this._attributeHash(o)+"-"+a,h=this._groupIdCache.get(l);if(h)return h;const u={...r,spatialReference:this._info.spatialReference,abortOptions:s,fields:this._info.fields},c=await this._loader.getSymbolAsync(o,u),_=this._schemaUtilsModule.createSymbolSchema(c,this._symbolOptions),f=Z(_,this._info,e,s).then(d=>{if(d.type!=="expanded-cim")return re.error(new st("mapview-bad-type",`Found unexpected type ${d.type} in dictionary response`)),null;d.hash+="-"+a;for(const m of d.layers)m.scaleFactor=a,m.templateHash+="-"+a;return this._templates.createTemplateGroup(d,null)});return this._groupIdCache.put(l,f,1),f}async analyze(t,e,i,r,s,o){const a=e.getCursor(),l=[];for(;a.next();)l.push(this._analyzeFeature(a,i,r,s,o));return Promise.all(l)}match(t,e,i,r,s){return null}_attributeHash(t){let e="";for(const i of this._symbolFields){const r=this._fieldMap[i];r&&(e+=t.attributes[r]+"-")}return e}}export{pn as E,Tt as a,zn as b,k as e,Ss as l,Z as n,vi as t,Tn as x};
