import{e as p,y as m,n as F,l as L}from"./cast-a534ae90.js";import{g as O}from"./Graphic-1859ae71.js";import{j as Q}from"./Collection-7c37b74e.js";import{a as G,s as z}from"./Error-57322e92.js";import{x as D,E as Z,j as W}from"./promiseUtils-32d9c228.js";import{a as K,l as A}from"./reactiveUtils-5869e41a.js";import{r as P,t as X}from"./typedArrayUtil-d9bc5fbd.js";import{v as Y,r as tt}from"./ensureType-25b8cc06.js";import{a as et}from"./BitmapContainer-b9fd36c2.js";import{y as rt}from"./LayerView2D-fc5f87cc.js";import{o as it}from"./BaseGraphicContainer-b5497723.js";import{n as ot}from"./HighlightGraphicContainer-6207b2ca.js";import{v as st}from"./ExportStrategy-333562f0.js";import{u as at}from"./LayerView-a849dd77.js";import{_ as pt}from"./preload-helper-101896b7.js";import{y as nt}from"./symbols-75e7a993.js";import{h as mt}from"./string-480f3e3f.js";import{$ as lt}from"./unitUtils-dd6fb8ee.js";import{a as q,k as ht,o as ut,r as yt}from"./Extent-a1a1de42.js";import{i as dt,r as ct}from"./scaleUtils-c3568f87.js";import{g as ft}from"./OperationalLayer-1dad72ac.js";import{n as U,c as gt}from"./ExportImageParameters-3714ed4b.js";import{s as T,c as wt}from"./index-7dfdb274.js";import{U as vt}from"./request-f17a8ddb.js";import{f as bt,v as xt,a as $t,b as It}from"./normalizeUtils-6483f6b5.js";import{t as _t}from"./LayerFloorInfo-e7c896e5.js";import{c as Et,v as St}from"./jsonUtils-c6684c52.js";import{i as Pt}from"./sublayerUtils-eea48c01.js";import{i as Rt}from"./geometry-eec1b371.js";import{T as Ft}from"./TimeExtent-2004eecf.js";import{t as jt}from"./typeUtils-cd52dc20.js";import{i as Nt}from"./arcadeOnDemand-5175e7d9.js";import{i as Ot}from"./GraphicsLayer-a7c6f685.js";import{d as Ut,s as Vt}from"./popupUtils-57580c23.js";import{i as Gt}from"./RefreshableLayerView-2de321c7.js";import"./nextTick-3ee5a785.js";import"./PopupTemplate-52faab17.js";import"./Clonable-9b34e760.js";import"./fieldUtils-77ec75e2.js";import"./jsonMap-190c5593.js";import"./enumeration-61a13175.js";import"./number-2ab8ca0d.js";import"./locale-30120714.js";import"./Identifiable-093f90a8.js";import"./Evented-cbf5f368.js";import"./SimpleObservable-8e532943.js";import"./WGLContainer-b2d1fffc.js";import"./mat3f32-d3d088e8.js";import"./enums-64ab819c.js";import"./mat3-9a8d9db7.js";import"./common-c186b691.js";import"./vec2f32-461e65a9.js";import"./pixelUtils-cc2ca9c3.js";import"./utils-0d179f64.js";import"./EffectView-dffeb0bc.js";import"./parser-01f6451e.js";import"./colorUtils-639f4d25.js";import"./screenUtils-90993e16.js";import"./mat4f32-77b3d8ac.js";import"./mat4-7dde83b1.js";import"./vec3f64-6cd30318.js";import"./enums-4ca4641f.js";import"./MaterialKey-a0a08f8b.js";import"./alignmentUtils-ae955d28.js";import"./Utils-a4216b91.js";import"./number-954e4ab6.js";import"./mathUtils-57aba1ea.js";import"./vec3-1863987c.js";import"./vec4-46a9b36d.js";import"./enums-4b2a86a0.js";import"./Texture-411ca148.js";import"./context-util-d4c193b5.js";import"./VertexElementDescriptor-2925c6af.js";import"./definitions-2d0dd0cd.js";import"./heatmapUtils-3d7c22c5.js";import"./vec4f64-939de194.js";import"./Color-af6e0c66.js";import"./vec2f64-30dc1443.js";import"./VertexArrayObject-3630ef4f.js";import"./vec4f32-2f36231b.js";import"./ProgramTemplate-f021fc55.js";import"./StyleDefinition-7d58136b.js";import"./config-1337d16e.js";import"./GeometryUtils-c093d234.js";import"./earcut-58237617.js";import"./vec2-ab9f47bf.js";import"./featureConversionUtils-d2229ed4.js";import"./OptimizedFeature-73582c6e.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./collectionUtils-0365f48b.js";import"./Polyline-b571c705.js";import"./cimAnalyzer-020551ab.js";import"./fontUtils-4ed0e787.js";import"./BidiEngine-836b7ef6.js";import"./aaBoundingRect-b340cf8c.js";import"./utils-0c7f5071.js";import"./mat2d-d0b91e3e.js";import"./Rect-ea14f53a.js";import"./callExpressionWithFeature-13fe9b68.js";import"./utils-52ad3c09.js";import"./generateRendererUtils-2f0b667c.js";import"./colorRamps-8d7efc14.js";import"./Symbol-8266348e.js";import"./GeometryUtils-eebff0a0.js";import"./floatRGBA-090399ba.js";import"./HandleOwner-2edbba46.js";import"./normalizeUtilsSync-a801e3b6.js";import"./utils-63166b41.js";import"./projection-0af97a56.js";import"./assets-a5ce5e1a.js";import"./zscale-48bab05e.js";import"./json-48e3ea08.js";import"./labelingInfo-be3a629c.js";import"./labelUtils-4f4b54c6.js";import"./defaultsJSON-59981e75.js";import"./jsonUtils-eb568237.js";import"./FeatureContainer-e57c4b30.js";import"./TileContainer-a618bf74.js";import"./TileKey-9cae9369.js";import"./Queue-275a6362.js";import"./visualVariablesUtils-c668eb89.js";import"./visualVariablesUtils-3304d1a5.js";import"./lengthUtils-92fed992.js";import"./capabilities-d08b6e58.js";import"./Matcher-e07e835b.js";import"./TileStrategy-a5366189.js";import"./TileStore-8f580dbf.js";import"./rbush-8e36784a.js";import"./quickselect-322ec8e1.js";import"./Query-13124a97.js";import"./Field-1d4f9ca4.js";import"./fieldType-b34e5d2d.js";import"./tileUtils-dbff68ee.js";import"./TileClipper-9381cfab.js";import"./Geometry-daada628.js";import"./LRUCache-b9228ca3.js";import"./MemCache-1d2f56ee.js";import"./ExpandedCIM-5a2216e6.js";import"./devEnvironmentUtils-5002a058.js";import"./Portal-51616380.js";import"./Loadable-46524a7e.js";import"./Promise-368b703a.js";import"./PortalGroup-d495847c.js";import"./PortalUser-e16fc7d1.js";import"./persistableUrlUtils-56d43b12.js";import"./styleUtils-015eeecd.js";import"./schemaUtils-5803029f.js";import"./diffUtils-8a8cb5bc.js";import"./createSymbolSchema-1bb8123a.js";import"./rendererUtils-c63e720f.js";import"./FeatureReductionLayer-1e5c4045.js";import"./BlendLayer-813950f9.js";import"./UniqueValueRenderer-30750d31.js";import"./LegendOptions-2e7b3d70.js";import"./opacityUtils-1333f803.js";import"./sizeVariableUtils-d4870b0d.js";import"./compilerUtils-fefa73ae.js";import"./jsonUtils-559e9000.js";import"./DictionaryLoader-326d0e17.js";import"./CIMSymbol-8f02a6e3.js";import"./deprecate-0d93948c.js";import"./util-0a217e96.js";import"./ComputedAttributeStorage-c1fec1a0.js";import"./FeatureSetReader-3d68adfe.js";import"./centroid-56c5816c.js";import"./FieldsIndex-16707836.js";import"./vec3f32-4322908d.js";import"./TileInfo-c5c8c8d2.js";import"./Bitmap-ff7d2c07.js";import"./symbolLayerUtils3D-c8c40895.js";import"./aaBoundingBox-4a83dbbc.js";import"./ElevationInfo-88554f24.js";import"./Basemap-f70b1b37.js";import"./loadAll-01cdf0a9.js";import"./asyncUtils-087555fc.js";import"./PortalItem-6eebfb2b.js";import"./messages-28bf3b89.js";import"./writeUtils-3bde6e49.js";import"./layerUtils-68eea656.js";import"./CollectionFlattener-f43a0fce.js";import"./TablesMixin-a4aaaf91.js";import"./Layer-ead8c88c.js";import"./Cyclical-078b4564.js";import"./workers-5d67fe7a.js";import"./Connection-b756149d.js";import"./intl-70c09a3c.js";import"./widget-09d2e7af.js";import"./uuid-73213768.js";import"./dom-5b7af1bf.js";import"./byteSizeEstimations-90c5a50d.js";import"./executeQueryJSON-0696009a.js";import"./query-71223310.js";import"./pbfQueryUtils-c922ef32.js";import"./pbf-8b0546e8.js";import"./queryZScale-3c8de33a.js";import"./FeatureSet-9cc47aef.js";import"./RelationshipQuery-c27267ab.js";import"./utils-4aa03157.js";import"./ItemCache-bf1028d4.js";import"./TopFeaturesQuery-9aca00bf.js";import"./FeatureLayer-9a7e04cf.js";import"./MultiOriginJSONSupport-b8792dfa.js";import"./FeatureLayerBase-d5682b4b.js";import"./HeightModelInfo-34f16d74.js";import"./arcgisLayerUrl-6e9db12f.js";import"./editsZScale-12d81957.js";import"./APIKeyMixin-b6e4f897.js";import"./ArcGISService-e571bcff.js";import"./CustomParametersMixin-a5d06ccc.js";import"./EditBusLayer-b5dc3689.js";import"./OrderedLayer-9623e905.js";import"./PortalLayer-9dd15f09.js";import"./RefreshableLayer-49182ab8.js";import"./ScaleRangeLayer-c072e266.js";import"./TemporalLayer-f784dd83.js";import"./TimeInfo-f76d6c20.js";import"./FeatureTemplate-c4496b93.js";import"./FeatureType-0be9420b.js";import"./fieldProperties-9e220f14.js";import"./versionUtils-f229b9a6.js";import"./styleUtils-08eaa4d2.js";import"./popupUtils-88fed094.js";import"./colorUtils-82440b70.js";import"./Scheduler-5e6ccc87.js";import"./ViewingMode-915d19cb.js";import"./unitBezier-881ac1eb.js";import"./Subtype-a3103d84.js";import"./datetime-4f774298.js";import"./elevationInfoUtils-44cce436.js";import"./QueryEngineResult-eb704fb1.js";import"./WhereClause-6c9440a1.js";import"./Util-289ce3b5.js";import"./webStyleSymbolUtils-6bef877f.js";import"./dehydratedFeatures-3dcd65f1.js";import"./plane-46a8c767.js";import"./sphere-622880b9.js";import"./quatf64-c94bd656.js";import"./mat4f64-fbeb2cd1.js";import"./quat-ec16a584.js";const M=o=>o.spatialReference.wkid||JSON.stringify(o.spatialReference);function At(o,t){const{dpi:e,gdbVersion:i,geometry:r,geometryPrecision:s,height:u,layerOption:l,mapExtent:a,maxAllowableOffset:n,returnFieldName:h,returnGeometry:y,returnUnformattedValues:g,returnZ:I,spatialReference:x,timeExtent:$,tolerance:c,width:E}=o.toJSON(),{dynamicLayers:w,layerDefs:f,layerIds:v}=Tt(o),V=t&&P(t.geometry)?t.geometry:null,b={geometryPrecision:s,maxAllowableOffset:n,returnFieldName:h,returnGeometry:y,returnUnformattedValues:g,returnZ:I,tolerance:c},S=V&&V.toJSON()||r;if(b.imageDisplay=`${E},${u},${e}`,i&&(b.gdbVersion=i),S&&(delete S.spatialReference,b.geometry=JSON.stringify(S),b.geometryType=Et(S)),x?b.sr=x.wkid||JSON.stringify(x):S&&S.spatialReference?b.sr=M(S):a&&a.spatialReference&&(b.sr=M(a)),b.time=$?[$.start,$.end].join(","):null,a){const{xmin:C,ymin:H,xmax:B,ymax:k}=a;b.mapExtent=`${C},${H},${B},${k}`}return f&&(b.layerDefs=f),w&&!f&&(b.dynamicLayers=w),b.layers=l==="popup"?"visible":l,v&&!w&&(b.layers+=`:${v.join(",")}`),b}function Tt(o){var x,$;const{mapExtent:t,floors:e,width:i,sublayers:r,layerIds:s,layerOption:u,gdbVersion:l}=o,a=($=(x=r==null?void 0:r.find(c=>c.layer!=null))==null?void 0:x.layer)==null?void 0:$.serviceSublayers,n=u==="popup",h={},y=dt({extent:t,width:i,spatialReference:t==null?void 0:t.spatialReference}),g=[],I=c=>{const E=y===0,w=c.minScale===0||y<=c.minScale,f=c.maxScale===0||y>=c.maxScale;if(c.visible&&(E||w&&f))if(c.sublayers)c.sublayers.forEach(I);else{if((s==null?void 0:s.includes(c.id))===!1||n&&(!c.popupTemplate||!c.popupEnabled))return;g.unshift(c)}};if(r==null||r.forEach(I),r&&!g.length)h.layerIds=[];else{const c=Pt(g,a,l),E=g.map(w=>{const f=U(e,w);return w.toExportImageJSON(f)});if(c)h.dynamicLayers=JSON.stringify(E);else{if(r){let f=g.map(({id:v})=>v);s&&(f=f.filter(v=>s.includes(v))),h.layerIds=f}else s!=null&&s.length&&(h.layerIds=s);const w=Mt(e,g);if(P(w)&&w.length){const f={};for(const v of w)v.definitionExpression&&(f[v.id]=v.definitionExpression);Object.keys(f).length&&(h.layerDefs=JSON.stringify(f))}}}return h}function Mt(o,t){const e=!!(o!=null&&o.length),i=t.filter(r=>r.definitionExpression!=null||e&&r.floorInfo!=null);return i.length?i.map(r=>{const s=U(o,r),u=_t(s,r.definitionExpression);return{id:r.id,definitionExpression:u}}):null}var N;let d=N=class extends L{constructor(o){super(o),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}static from(o){return Y(N,o)}};p([m({type:Number,json:{write:!0}})],d.prototype,"dpi",void 0),p([m()],d.prototype,"floors",void 0),p([m({type:String,json:{write:!0}})],d.prototype,"gdbVersion",void 0),p([m({types:Rt,json:{read:St,write:!0}})],d.prototype,"geometry",void 0),p([m({type:Number,json:{write:!0}})],d.prototype,"geometryPrecision",void 0),p([m({type:Number,json:{write:!0}})],d.prototype,"height",void 0),p([m({type:[Number],json:{write:!0}})],d.prototype,"layerIds",void 0),p([m({type:["top","visible","all","popup"],json:{write:!0}})],d.prototype,"layerOption",void 0),p([m({type:q,json:{write:!0}})],d.prototype,"mapExtent",void 0),p([m({type:Number,json:{write:!0}})],d.prototype,"maxAllowableOffset",void 0),p([m({type:Boolean,json:{write:!0}})],d.prototype,"returnFieldName",void 0),p([m({type:Boolean,json:{write:!0}})],d.prototype,"returnGeometry",void 0),p([m({type:Boolean,json:{write:!0}})],d.prototype,"returnM",void 0),p([m({type:Boolean,json:{write:!0}})],d.prototype,"returnUnformattedValues",void 0),p([m({type:Boolean,json:{write:!0}})],d.prototype,"returnZ",void 0),p([m({type:ht,json:{write:!0}})],d.prototype,"spatialReference",void 0),p([m()],d.prototype,"sublayers",void 0),p([m({type:Ft,json:{write:!0}})],d.prototype,"timeExtent",void 0),p([m({type:Number,json:{write:!0}})],d.prototype,"tolerance",void 0),p([m({type:Number,json:{write:!0}})],d.prototype,"width",void 0),d=N=p([F("esri.rest.support.IdentifyParameters")],d);const J=d;let _=class extends L{constructor(t){super(t),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(t,e){return O.fromJSON({attributes:{...e.attributes},geometry:{...e.geometry}})}writeFeature(t,e){if(!t)return;const{attributes:i,geometry:r}=t;i&&(e.attributes={...i}),P(r)&&(e.geometry=r.toJSON(),e.geometryType=jt.toJSON(r.type))}};p([m({type:String,json:{write:!0}})],_.prototype,"displayFieldName",void 0),p([m({type:O})],_.prototype,"feature",void 0),p([ut("feature",["attributes","geometry"])],_.prototype,"readFeature",null),p([yt("feature")],_.prototype,"writeFeature",null),p([m({type:Number,json:{write:!0}})],_.prototype,"layerId",void 0),p([m({type:String,json:{write:!0}})],_.prototype,"layerName",void 0),_=p([F("esri.rest.support.IdentifyResult")],_);const Lt=_;async function qt(o,t,e){const i=(t=Ct(t)).geometry?[t.geometry]:[],r=bt(o);return r.path+="/identify",xt(i).then(s=>{const u=At(t,{geometry:s&&s[0]}),l=$t({...r.query,f:"json",...u}),a=It(l,e);return vt(r.path,a).then(Jt).then(n=>Ht(n,t.sublayers))})}function Jt(o){const t=o.data;return t.results=t.results||[],t.exceededTransferLimit=Boolean(t.exceededTransferLimit),t.results=t.results.map(e=>Lt.fromJSON(e)),t}function Ct(o){return o=J.from(o)}function Ht(o,t){if(!(t!=null&&t.length))return o;const e=new Map;function i(r){e.set(r.id,r),r.sublayers&&r.sublayers.forEach(i)}t.forEach(i);for(const r of o.results)r.feature.sourceLayer=e.get(r.layerId);return o}let j=null;const Bt=o=>{let t=class extends o{constructor(){super(...arguments),this._featuresResolutions=new WeakMap,this.highlightGraphics=new Ot,this.updateHighlightedFeatures=D(async e=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch(()=>{}))})}initialize(){this.exportImageParameters=new gt({layer:this.layer}),this.handles.add([K(()=>this.highlightGraphics,"change",e=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e.added).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)})])}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var e;return(e=this.exportImageParameters)==null||e.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(e,i){var u,l,a,n;const{layer:r}=this;if(!e)throw new G("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:r});const s=((l=(u=this.layer.capabilities)==null?void 0:u.operations)==null?void 0:l.supportsQuery)??!0;if(!((((n=(a=this.layer.capabilities)==null?void 0:a.operations)==null?void 0:n.supportsIdentify)??!0)&&this.layer.version>=10.5)&&!s)throw new G("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:r});return s?this._fetchPopupFeaturesUsingQueries(e,i):this._fetchPopupFeaturesUsingIdentify(e,i)}canResume(){var e;return!!super.canResume()&&!((e=this.timeExtent)!=null&&e.isEmpty)}async _updateHighlightedFeaturesSymbols(e){for(const i of e){const r="renderer"in i.sourceLayer&&i.sourceLayer.renderer;"geometryType"in i.sourceLayer&&i.sourceLayer.geometryType==="point"&&r&&"getSymbolAsync"in r&&r.getSymbolAsync(i).then(async s=>{var a;let u="width"in s&&"height"in s&&s.width!=null&&s.height!=null?Math.max(s.width,s.height):"size"in s?s.size:null;const l="visualVariables"in r&&((a=r.visualVariables)==null?void 0:a.find(n=>n.type==="size"));l&&(j||(j=(await pt(()=>import("./UniqueValueRenderer-30750d31.js").then(n=>n.v),["assets/UniqueValueRenderer-30750d31.js","assets/cast-a534ae90.js","assets/typedArrayUtil-d9bc5fbd.js","assets/string-480f3e3f.js","assets/Error-57322e92.js","assets/ensureType-25b8cc06.js","assets/nextTick-3ee5a785.js","assets/promiseUtils-32d9c228.js","assets/symbols-75e7a993.js","assets/CIMSymbol-8f02a6e3.js","assets/enumeration-61a13175.js","assets/jsonMap-190c5593.js","assets/Extent-a1a1de42.js","assets/fieldUtils-77ec75e2.js","assets/preload-helper-101896b7.js","assets/arcadeOnDemand-5175e7d9.js","assets/geometry-eec1b371.js","assets/Polyline-b571c705.js","assets/typeUtils-cd52dc20.js","assets/Symbol-8266348e.js","assets/Color-af6e0c66.js","assets/colorUtils-639f4d25.js","assets/mathUtils-57aba1ea.js","assets/vec3-1863987c.js","assets/vec3f64-6cd30318.js","assets/common-c186b691.js","assets/vec4-46a9b36d.js","assets/screenUtils-90993e16.js","assets/opacityUtils-1333f803.js","assets/symbolLayerUtils3D-c8c40895.js","assets/aaBoundingBox-4a83dbbc.js","assets/aaBoundingRect-b340cf8c.js","assets/request-f17a8ddb.js","assets/persistableUrlUtils-56d43b12.js","assets/Collection-7c37b74e.js","assets/Evented-cbf5f368.js","assets/SimpleObservable-8e532943.js","assets/collectionUtils-0365f48b.js","assets/Portal-51616380.js","assets/Loadable-46524a7e.js","assets/Promise-368b703a.js","assets/locale-30120714.js","assets/PortalGroup-d495847c.js","assets/PortalUser-e16fc7d1.js","assets/Clonable-9b34e760.js","assets/LegendOptions-2e7b3d70.js","assets/reactiveUtils-5869e41a.js","assets/diffUtils-8a8cb5bc.js","assets/colorRamps-8d7efc14.js","assets/sizeVariableUtils-d4870b0d.js","assets/Graphic-1859ae71.js","assets/PopupTemplate-52faab17.js","assets/number-2ab8ca0d.js","assets/Identifiable-093f90a8.js","assets/jsonUtils-c6684c52.js","assets/compilerUtils-fefa73ae.js","assets/lengthUtils-92fed992.js","assets/unitUtils-dd6fb8ee.js","assets/jsonUtils-eb568237.js","assets/styleUtils-015eeecd.js"])).getSize),u=j(l,i,{view:this.view.type,scale:this.view.scale,shape:s.type==="simple-marker"?s.style:null})),this.highlightGraphics.includes(i)&&(i.symbol=new nt({style:"square",size:u,xoffset:"xoffset"in s?s.xoffset:0,yoffset:"yoffset"in s?s.yoffset:0}),i.visible=!0,this.highlightGraphicUpdated(i,"symbol"))})}}async _updateHighlightedFeaturesGeometries(e){this._highlightGeometriesResolution=e;const i=this.highlightGraphics;if(!i.length||!this.layer.capabilities.operations.supportsQuery)return;const r=this._getTargetResolution(e),s=new Map;for(const a of i)if(!this._featuresResolutions.has(a)||this._featuresResolutions.get(a)>r){const n=a.sourceLayer;tt(s,n,()=>new Map).set(a.getObjectId(),a)}const u=Array.from(s,([a,n])=>{const h=a.createQuery();return h.objectIds=[...n.keys()],h.outFields=[a.objectIdField],h.returnGeometry=!0,h.maxAllowableOffset=r,h.outSpatialReference=this.view.spatialReference,a.queryFeatures(h)}),l=await Promise.all(u);if(!this.destroyed)for(const{features:a}of l)for(const n of a){const h=n.sourceLayer,y=s.get(h).get(n.getObjectId());y&&this.highlightGraphics.includes(y)&&(y.geometry=n.geometry,this.highlightGraphicUpdated(y,"geometry"),this._featuresResolutions.set(y,r))}}_getTargetResolution(e){const i=e*lt(this.view.spatialReference),r=i/16;return r<=10?0:e/i*r}async _fetchPopupFeaturesUsingIdentify(e,i){const r=await this._createIdentifyParameters(e,i);if(X(r))return[];const{results:s}=await qt(this.layer.parsedUrl,r);return s.map(u=>u.feature)}async _createIdentifyParameters(e,i){const{floors:r,spatialReference:s,scale:u}=this.view,l=P(i)?i.event:null,a=await this._collectPopupProviders(this.layer.sublayers,u,i);if(!a.length)return null;await Promise.all(a.map(({sublayer:x})=>x.load().catch(()=>{})));const n=Math.min(mt("mapimagelayer-popup-identify-max-tolerance"),this.layer.allSublayers.reduce((x,$)=>$.renderer?T({renderer:$.renderer,event:l}):x,2)),h=this.createFetchPopupFeaturesQueryGeometry(e,n),y=ct(u,s),g=Math.round(h.width/y),I=new q({xmin:h.center.x-y*g,ymin:h.center.y-y*g,xmax:h.center.x+y*g,ymax:h.center.y+y*g,spatialReference:h.spatialReference});return new J({floors:r,gdbVersion:this.layer.gdbVersion,geometry:e,height:g,layerOption:"popup",mapExtent:I,returnGeometry:!0,spatialReference:s,sublayers:this.layer.sublayers,timeExtent:this.timeExtent,tolerance:n,width:g})}async _fetchPopupFeaturesUsingQueries(e,i){const r=await this._collectPopupProviders(this.layer.sublayers,this.view.scale,i),s=P(i)?i.event:null,u=r.map(async({sublayer:l,popupTemplate:a})=>{var E,w;await l.load().catch(()=>{});const n=l.createQuery(),h=T({renderer:l.renderer,event:s}),y=this.createFetchPopupFeaturesQueryGeometry(e,h);if(n.geometry=y,n.outFields=await Ut(l,a),n.timeExtent=this.timeExtent,"floors"in this.view){const f=(w=(E=this.view)==null?void 0:E.floors)==null?void 0:w.clone(),v=U(f,l);P(v)&&(n.where=n.where?`(${n.where}) AND (${v})`:v)}const g=this._getTargetResolution(y.width/h),I=await this._loadArcadeModules(a),x=l.geometryType==="point"||I&&I.arcadeUtils.hasGeometryOperations(a);x||(n.maxAllowableOffset=g);const{features:$}=await l.queryFeatures(n),c=x?0:g;for(const f of $)this._featuresResolutions.set(f,c);return $});return(await Z(u)).reverse().reduce((l,a)=>a.value?[...l,...a.value]:l,[]).filter(l=>l!=null)}async _collectPopupProviders(e,i,r){const s=[],u=async a=>{const n=a.minScale===0||i<=a.minScale,h=a.maxScale===0||i>=a.maxScale;if(a.visible&&n&&h){if(a.sublayers)a.sublayers.forEach(u);else if(a.popupEnabled){const y=Vt(a,{...r,defaultPopupTemplateEnabled:!1});P(y)&&s.unshift({sublayer:a,popupTemplate:y})}}},l=e.toArray().reverse().map(u);return await Promise.all(l),s}_loadArcadeModules(e){var i;if((i=e.expressionInfos)!=null&&i.length||Array.isArray(e.content)&&e.content.some(r=>r.type==="expression"))return Nt()}};return p([m()],t.prototype,"highlightGraphics",void 0),p([m()],t.prototype,"exportImageParameters",void 0),p([m({readOnly:!0})],t.prototype,"exportImageVersion",null),p([m()],t.prototype,"layer",void 0),p([m()],t.prototype,"suspended",void 0),p([m(ft)],t.prototype,"timeExtent",void 0),t=p([F("esri.views.layers.MapImageLayerView")],t),t};let R=class extends Bt(Gt(rt(at))){update(o){this.strategy.update(o).catch(t=>{W(t)||z.getLogger(this.declaredClass).error(t)}),o.stationary&&this.updateHighlightedFeatures(o.state.resolution),this._highlightView.processUpdate(o)}attach(){const{imageMaxWidth:o,imageMaxHeight:t,version:e}=this.layer,i=e>=10.3,r=e>=10;this._bitmapContainer=new et,this.container.addChild(this._bitmapContainer),this._highlightView=new it({view:this.view,graphics:this.highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new ot(this.view.featuresTilingScheme)}),this.container.addChild(this._highlightView.container),this.strategy=new st({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:o,imageMaxHeight:t,imageRotationSupported:i,imageNormalizationSupported:r,hidpi:!0}),this.handles.add(A(()=>this.exportImageVersion,()=>this.requestUpdate()),"exportImageVersion"),this.handles.add(A(()=>{var s;return(s=this.view)==null?void 0:s.floors},()=>this.requestUpdate()),"view.floors"),this.requestUpdate()}detach(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(o){let t=null;if(o instanceof O?t=[o]:Q.isCollection(o)&&o.length>0?t=o.toArray():Array.isArray(o)&&o.length>0&&(t=o),t=t==null?void 0:t.filter(Boolean),!t||!t.length)return{remove:()=>{}};for(const e of t)"geometryType"in e.sourceLayer&&e.sourceLayer.geometryType==="point"&&(e.visible=!1);return this.highlightGraphics.addMany(t),{remove:()=>{this.highlightGraphics.removeMany(t)}}}supportsSpatialReference(o){return this.layer.serviceSupportsSpatialReference(o)}createFetchPopupFeaturesQueryGeometry(o,t){return wt(o,t,this.view)}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}highlightGraphicUpdated(o,t){this._highlightView.graphicUpdateHandler({graphic:o,property:t})}fetchImage(o,t,e,i){return this.layer.fetchImage(o,t,e,{timeExtent:this.timeExtent,floors:this.view.floors,...i})}fetchImageBitmap(o,t,e,i){return this.layer.fetchImageBitmap(o,t,e,{timeExtent:this.timeExtent,floors:this.view.floors,...i})}};p([m()],R.prototype,"strategy",void 0),p([m()],R.prototype,"updating",void 0),R=p([F("esri.views.2d.layers.MapImageLayerView2D")],R);const fs=R;export{fs as default};
